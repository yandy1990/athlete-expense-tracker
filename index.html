<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Athlete Expense Tracker</title>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Day.js for dates -->
    <script src="https://unpkg.com/dayjs@1.11.11/dayjs.min.js"></script>

    <!-- Babel for JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>

  <body class="bg-slate-100">
    <div id="root"></div>

    <!-- Our app code (JSX) -->
    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo, useRef } = React;

      const STORAGE_KEY = "athlete_expenses_v1";

      const CATEGORIES = [
        "Accommodations",
        "Food & Meals",
        "Car Rental",
        "Uber / Taxi",
        "Travel (Flights / Train)",
        "Tennis Coaching Fee",
        "Fitness Coaching Fee",
        "Physio Fee",
        "Medical Expenses",
        "Equipment",
        "Other Training Expenses",
        "Telecommunications",
        "Other Business Related Expense",
        "Other"
      ];

      const PAYERS = ["Athlete", "Parent", "Team", "Sponsor", "Other"];

      const CONTEXT_TYPES = ["Tournament", "Training", "Event"];

      const FX_SUPPORTED = ["USD", "EUR", "GBP", "AUD", "JPY", "CAD"];

      const REGION_OPTIONS = [
        "US",
        "Europe",
        "UK",
        "Asia",
        "Middle East",
        "South America",
        "Oceania",
        "Africa",
        "Other"
      ];

      function normalizeCurrency(code) {
        if (!code) return "";
        const upper = code.toUpperCase();
        if (upper === "CND" || upper === "CAN") return "CAD"; // common typo
        return upper;
      }

      function loadExpenses() {
        try {
          const raw = window.localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) {
            if (parsed && Array.isArray(parsed.expenses)) return parsed.expenses;
            return [];
          }
          return parsed;
        } catch (e) {
          console.error("Failed to load from localStorage", e);
          return [];
        }
      }

      function saveExpenses(expenses) {
        try {
          window.localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
        } catch (e) {
          console.error("Failed to save to localStorage", e);
        }
      }

      function uuid() {
        return (
          Date.now().toString(36) + Math.random().toString(36).substring(2, 8)
        );
      }

      function sumAmounts(items) {
        return items.reduce((acc, x) => acc + (Number(x.amount) || 0), 0);
      }

      /**
       * Convert an amount in `currency` to USD.
       *
       * Priority:
       * 1) If currency is USD -> return amount
       * 2) If manualRateToUSD provided -> amount * manualRateToUSD
       * 3) Else use fxRates (1 USD = rate * CURRENCY => 1 CURRENCY = 1 / rate USD)
       */
      function toUSD(amount, currency, fxRates, manualRateToUSD) {
        const code = normalizeCurrency(currency);
        if (!amount || !code) return null;

        const num = Number(amount);
        if (isNaN(num)) return null;

        if (code === "USD") return num;

        // manual override
        if (manualRateToUSD && manualRateToUSD > 0) {
          return num * manualRateToUSD;
        }

        // API-based FX
        if (!fxRates || !fxRates[code]) return null;

        const rate = fxRates[code];
        if (!rate || rate === 0) return null;

        return num / rate;
      }

      // ----- CSV helpers -----
      function buildCSVFromObjects(rows) {
        if (!rows || !rows.length) return "";
        const headers = Object.keys(rows[0]);
        const escapeCell = (val) => {
          if (val === null || val === undefined) return '""';
          const str = String(val).replace(/"/g, '""');
          return `"${str}"`;
        };
        const lines = [];
        lines.push(headers.map((h) => `"${h}"`).join(","));
        rows.forEach((row) => {
          lines.push(headers.map((h) => escapeCell(row[h])).join(","));
        });
        return lines.join("\r\n");
      }

      function downloadFile(filename, contents, mimeType) {
        const blob = new Blob([contents], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function downloadCSV(filename, rows) {
        const csv = buildCSVFromObjects(rows);
        downloadFile(filename, csv, "text/csv;charset=utf-8;");
      }

      // ----- Expense Form -----
      function ExpenseForm({ onAdd }) {
        const today = dayjs().format("YYYY-MM-DD");
        const [date, setDate] = useState(today);

        const [contextType, setContextType] = useState("Tournament");
        const [trip, setTrip] = useState("");
        const [region, setRegion] = useState("");

        const [category, setCategory] = useState(CATEGORIES[0]);

        // multiple amounts per expense
        const [amountInputs, setAmountInputs] = useState([""]);
        const [currency, setCurrency] = useState("USD");

        // manual FX rate for unsupported currencies
        // 1 UNIT of this currency = manualRateToUSD USD
        const [manualRate, setManualRate] = useState("");

        const [payer, setPayer] = useState(PAYERS[0]);
        const [notes, setNotes] = useState("");

        // receipt files (File objects)
        const [receiptFiles, setReceiptFiles] = useState([]);

        const normalizedCurrency = normalizeCurrency(currency);
        const isSupportedCurrency = FX_SUPPORTED.includes(normalizedCurrency);

        const contextLabel =
          contextType === "Tournament"
            ? "Tournament Name"
            : contextType === "Training"
            ? "Training Location (City)"
            : "Event Name";

        const contextPlaceholder =
          contextType === "Tournament"
            ? "e.g., 2025 Australian Open"
            : contextType === "Training"
            ? "e.g., Barcelona"
            : "e.g., Sponsor shoot – Nike";

        function handleAmountChange(index, value) {
          const next = [...amountInputs];
          next[index] = value;
          setAmountInputs(next);
        }

        function addAmountLine() {
          setAmountInputs((prev) => [...prev, ""]);
        }

        function removeAmountLine(index) {
          setAmountInputs((prev) => prev.filter((_, i) => i !== index));
        }

        const parsedAmounts = amountInputs
          .map((v) => Number(v))
          .filter((n) => !isNaN(n) && n > 0);

        const totalAmount = parsedAmounts.reduce((a, b) => a + b, 0);

        function handleCurrencyInput(value) {
          const norm = normalizeCurrency(value);
          setCurrency(norm);
          // Clear manual rate when switching back to supported FX currencies
          if (FX_SUPPORTED.includes(norm)) {
            setManualRate("");
          }
        }

        function handleReceiptsChange(e) {
          const files = Array.from(e.target.files || []);
          setReceiptFiles(files);
        }

        function readFileAsDataURL(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => {
              resolve({
                id: uuid(),
                name: file.name,
                type: file.type,
                dataUrl: reader.result
              });
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }

        async function handleSubmit(e) {
          e.preventDefault();

          if (parsedAmounts.length === 0 || totalAmount <= 0) {
            alert("Please enter at least one positive amount.");
            return;
          }

          const normCur = normalizedCurrency || "USD";

          let manualRateNum = null;
          if (!FX_SUPPORTED.includes(normCur) && manualRate) {
            const parsed = Number(manualRate);
            if (isNaN(parsed) || parsed <= 0) {
              alert(
                "Manual conversion rate must be a positive number (e.g., 1.25 means 1 " +
                  normCur +
                  " = 1.25 USD)."
              );
              return;
            }
            manualRateNum = parsed;
          }

          let receipts = [];
          if (receiptFiles.length > 0) {
            try {
              receipts = await Promise.all(
                receiptFiles.map((f) => readFileAsDataURL(f))
              );
            } catch (err) {
              console.error("Failed to read receipt file(s)", err);
              alert("Failed to read one or more receipt files.");
            }
          }

          const tournamentRegion =
            contextType === "Tournament" ? region.trim() : "";

          const exp = {
            id: uuid(),
            date,
            trip: trip.trim(),
            tripType: contextType,
            region: tournamentRegion, // only meaningful for tournaments
            category,
            amount: totalAmount,
            subAmounts: parsedAmounts,
            currency: normCur,
            manualRateToUSD: manualRateNum, // may be null
            payer,
            notes: notes.trim(),
            receipts
          };

          onAdd(exp);

          // Reset amounts, notes, receipts; keep date, contextType, trip, currency, region
          setAmountInputs([""]);
          setNotes("");
          setReceiptFiles([]);
        }

        return (
          <form
            onSubmit={handleSubmit}
            className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 grid grid-cols-1 md:grid-cols-2 gap-4"
          >
            <h2 className="md:col-span-2 text-xl font-semibold text-slate-800">
              Add Expense
            </h2>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Date
              </label>
              <input
                type="date"
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Type
              </label>
              <select
                value={contextType}
                onChange={(e) => setContextType(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {CONTEXT_TYPES.map((t) => (
                  <option key={t} value={t}>
                    {t}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                {contextLabel}
              </label>
              <input
                type="text"
                placeholder={contextPlaceholder}
                value={trip}
                onChange={(e) => setTrip(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              />
            </div>

            {contextType === "Tournament" && (
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Region (for tournament comparisons)
                </label>
                <select
                  value={region}
                  onChange={(e) => setRegion(e.target.value)}
                  className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                >
                  <option value="">Select region</option>
                  {REGION_OPTIONS.map((r) => (
                    <option key={r} value={r}>
                      {r}
                    </option>
                  ))}
                </select>
              </div>
            )}

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Category
              </label>
              <select
                value={category}
                onChange={(e) => setCategory(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {CATEGORIES.map((c) => (
                  <option key={c} value={c}>
                    {c}
                  </option>
                ))}
              </select>
            </div>

            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Amounts (you can enter multiple, e.g. 3 meals)
              </label>

              <div className="space-y-2">
                {amountInputs.map((val, index) => (
                  <div key={index} className="flex items-center gap-2">
                    <input
                      type="number"
                      step="0.01"
                      min="0"
                      value={val}
                      onChange={(e) =>
                        handleAmountChange(index, e.target.value)
                      }
                      className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                      placeholder={`Line ${index + 1}`}
                    />
                    {amountInputs.length > 1 && (
                      <button
                        type="button"
                        onClick={() => removeAmountLine(index)}
                        className="text-xs text-red-600 hover:text-red-700"
                      >
                        Remove
                      </button>
                    )}
                  </div>
                ))}
                <button
                  type="button"
                  onClick={addAmountLine}
                  className="text-xs text-slate-700 hover:text-slate-900"
                >
                  + Add another amount
                </button>
              </div>

              <div className="mt-2 text-xs text-slate-600">
                Total:{" "}
                <span className="font-semibold">
                  {totalAmount.toFixed(2)} {normalizedCurrency}
                </span>
              </div>
            </div>

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Currency (USD, EUR, GBP, AUD, JPY, CAD, or others)
              </label>
              <input
                type="text"
                value={currency}
                onChange={(e) => handleCurrencyInput(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm uppercase focus:outline-none focus:ring-2 focus:ring-slate-500"
              />
              {!isSupportedCurrency && normalizedCurrency && (
                <p className="mt-1 text-xs text-amber-700">
                  This currency is not in the live FX list; you can enter a
                  manual rate below so USD totals can be calculated.
                </p>
              )}
            </div>

            {!isSupportedCurrency && normalizedCurrency && (
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">
                  Manual conversion to USD
                </label>
                <div className="flex items-center gap-2 text-sm">
                  <span className="text-slate-700">
                    1&nbsp;{normalizedCurrency}&nbsp;=&nbsp;
                  </span>
                  <input
                    type="number"
                    step="0.0001"
                    min="0"
                    value={manualRate}
                    onChange={(e) => setManualRate(e.target.value)}
                    className="w-28 rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                    placeholder="e.g. 1.25"
                  />
                  <span className="text-slate-700">&nbsp;USD</span>
                </div>
                <p className="mt-1 text-xs text-slate-500">
                  Example: if 1 {normalizedCurrency} = 1.25 USD, enter{" "}
                  <span className="font-semibold">1.25</span>.
                </p>
              </div>
            )}

            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Paid By
              </label>
              <select
                value={payer}
                onChange={(e) => setPayer(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {PAYERS.map((p) => (
                  <option key={p} value={p}>
                    {p}
                  </option>
                ))}
              </select>
            </div>

            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Notes
              </label>
              <textarea
                rows={2}
                placeholder="e.g., Breakfast, lunch, dinner with coach"
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              />
            </div>

            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Receipts (JPG/PNG/PDF)
              </label>
              <input
                type="file"
                multiple
                accept="image/*,application/pdf"
                onChange={handleReceiptsChange}
                className="block w-full text-sm text-slate-700"
              />
              <p className="mt-1 text-xs text-slate-500">
                Files are stored in this browser only (no cloud) as encoded
                data. Large numbers of receipts may use more local storage.
              </p>
            </div>

            <div className="md:col-span-2 flex justify-end">
              <button
                type="submit"
                className="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800 transition"
              >
                Add Expense
              </button>
            </div>
          </form>
        );
      }

      function Filters({ filters, onChange, trips }) {
        function update(field, value) {
          onChange({ ...filters, [field]: value });
        }

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <h2 className="md:col-span-4 text-lg font-semibold text-slate-800">
              Filters
            </h2>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                From
              </label>
              <input
                type="date"
                value={filters.fromDate}
                onChange={(e) => update("fromDate", e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                To
              </label>
              <input
                type="date"
                value={filters.toDate}
                onChange={(e) => update("toDate", e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Tournament / Location / Event
              </label>
              <select
                value={filters.trip || ""}
                onChange={(e) => update("trip", e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                <option value="">All</option>
                {trips.map((t) => (
                  <option key={t} value={t}>
                    {t}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-slate-700 mb-1">
                Category
              </label>
              <select
                value={filters.category || ""}
                onChange={(e) => update("category", e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                <option value="">All</option>
                {CATEGORIES.map((c) => (
                  <option key={c} value={c}>
                    {c}
                  </option>
                ))}
              </select>
            </div>
          </div>
        );
      }

      // ----- Export Panel -----
      function ExportPanel({ expenses, fxRates }) {
        if (!expenses || expenses.length === 0) {
          return (
            <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 text-sm text-slate-500">
              No expenses to export. Adjust filters or add expenses first.
            </div>
          );
        }

        function exportDetailed() {
          const rows = expenses.map((e) => {
            const usd = toUSD(
              e.amount,
              e.currency,
              fxRates,
              e.manualRateToUSD || null
            );
            return {
              Date: e.date,
              Type: e.tripType || "",
              Trip: e.trip || "",
              Region: e.region || "",
              Category: e.category,
              Amount: e.amount,
              Currency: e.currency,
              ManualRateToUSD: e.manualRateToUSD || "",
              AmountUSD: usd != null ? usd.toFixed(2) : "",
              Payer: e.payer,
              Notes: e.notes,
              ReceiptsCount: e.receipts ? e.receipts.length : 0
            };
          });
          downloadCSV("expenses_detailed.csv", rows);
        }

        function exportByTrip() {
          const map = {};
          expenses.forEach((e) => {
            const key =
              (e.trip || "Unspecified") +
              " | " +
              (e.tripType || "") +
              " | " +
              (e.region || "");
            if (!map[key]) {
              map[key] = { expenses: [] };
            }
            map[key].expenses.push(e);
          });

          const rows = Object.entries(map).map(([key, value]) => {
            const parts = key.split(" | ");
            const tripName = parts[0];
            const type = parts[1];
            const region = parts[2] || "";
            const totalUSD = value.expenses.reduce((acc, e) => {
              const usd = toUSD(
                e.amount,
                e.currency,
                fxRates,
                e.manualRateToUSD || null
              );
              return acc + (usd || 0);
            }, 0);
            return {
              Type: type,
              Trip: tripName,
              Region: region,
              TotalUSD: totalUSD.toFixed(2),
              ExpenseCount: value.expenses.length
            };
          });

          downloadCSV("expenses_by_trip.csv", rows);
        }

        function exportByMonth() {
          const map = {};
          expenses.forEach((e) => {
            const d = dayjs(e.date);
            const key = d.isValid() ? d.format("YYYY-MM") : "Unknown";
            if (!map[key]) map[key] = [];
            map[key].push(e);
          });

          const rows = Object.entries(map).map(([monthKey, list]) => {
            const totalUSD = list.reduce((acc, e) => {
              const usd = toUSD(
                e.amount,
                e.currency,
                fxRates,
                e.manualRateToUSD || null
              );
              return acc + (usd || 0);
            }, 0);
            const label =
              monthKey === "Unknown"
                ? "Unknown"
                : dayjs(monthKey + "-01").isValid()
                ? dayjs(monthKey + "-01").format("MMMM YYYY")
                : monthKey;
            return {
              Month: label,
              RawKey: monthKey,
              TotalUSD: totalUSD.toFixed(2),
              ExpenseCount: list.length
            };
          });

          downloadCSV("expenses_by_month.csv", rows);
        }

        function exportByCategory() {
          const map = {};
          expenses.forEach((e) => {
            const key = e.category;
            const usd = toUSD(
              e.amount,
              e.currency,
              fxRates,
              e.manualRateToUSD || null
            );
            if (!usd) return;
            if (!map[key]) map[key] = 0;
            map[key] += usd;
          });

          const rows = Object.entries(map).map(([cat, total]) => ({
            Category: cat,
            TotalUSD: total.toFixed(2)
          }));

          downloadCSV("expenses_by_category.csv", rows);
        }

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6">
            <h2 className="text-lg font-semibold text-slate-800 mb-3">
              Export to CSV (opens in Excel)
            </h2>
            <p className="text-xs text-slate-500 mb-3">
              Export uses the <strong>currently filtered</strong> expenses.
            </p>
            <div className="flex flex-wrap gap-2">
              <button
                onClick={exportDetailed}
                className="px-3 py-2 rounded-xl border border-slate-300 text-xs font-medium text-slate-800 hover:bg-slate-50"
              >
                Detailed (filtered)
              </button>
              <button
                onClick={exportByTrip}
                className="px-3 py-2 rounded-xl border border-slate-300 text-xs font-medium text-slate-800 hover:bg-slate-50"
              >
                Summary by Trip
              </button>
              <button
                onClick={exportByMonth}
                className="px-3 py-2 rounded-xl border border-slate-300 text-xs font-medium text-slate-800 hover:bg-slate-50"
              >
                Summary by Month
              </button>
              <button
                onClick={exportByCategory}
                className="px-3 py-2 rounded-xl border border-slate-300 text-xs font-medium text-slate-800 hover:bg-slate-50"
              >
                Summary by Category
              </button>
            </div>
          </div>
        );
      }

      // ----- Backup Panel (Export / Import JSON) -----
      function BackupPanel({ expenses, onRestore }) {
        const fileInputRef = useRef(null);

        function handleExportBackup() {
          const payload = {
            version: 1,
            exportedAt: new Date().toISOString(),
            expenses
          };
          const json = JSON.stringify(payload, null, 2);
          const timestamp = dayjs().format("YYYYMMDD_HHmmss");
          downloadFile(
            `athlete_expenses_backup_${timestamp}.json`,
            json,
            "application/json;charset=utf-8;"
          );
        }

        function handleChooseFile() {
          if (fileInputRef.current) {
            fileInputRef.current.value = "";
            fileInputRef.current.click();
          }
        }

        function handleImportChange(e) {
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const text = reader.result;
              const data = JSON.parse(text);
              let importedExpenses = [];

              if (Array.isArray(data)) {
                importedExpenses = data;
              } else if (data && Array.isArray(data.expenses)) {
                importedExpenses = data.expenses;
              } else {
                alert("Backup format not recognized.");
                return;
              }

              if (
                !window.confirm(
                  "This will replace ALL current expenses with the backup data. Continue?"
                )
              ) {
                return;
              }

              onRestore(importedExpenses);
              alert("Backup imported successfully.");
            } catch (err) {
              console.error("Failed to import backup", err);
              alert("Failed to read backup file. Please check the file.");
            }
          };
          reader.onerror = () => {
            alert("Error reading backup file.");
          };
          reader.readAsText(file);
        }

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6">
            <h2 className="text-lg font-semibold text-slate-800 mb-3">
              Backup & Restore
            </h2>
            <p className="text-xs text-slate-500 mb-3">
              Export a full backup (including receipts & FX info) as a JSON
              file. You can import it on another computer or after reinstalling
              your browser.
            </p>
            <div className="flex flex-wrap gap-2 items-center">
              <button
                onClick={handleExportBackup}
                className="px-3 py-2 rounded-xl border border-slate-300 text-xs font-medium text-slate-800 hover:bg-slate-50"
              >
                Export Backup (.json)
              </button>
              <button
                onClick={handleChooseFile}
                className="px-3 py-2 rounded-xl border border-slate-300 text-xs font-medium text-slate-800 hover:bg-slate-50"
              >
                Import Backup (.json)
              </button>
              <input
                type="file"
                accept="application/json"
                ref={fileInputRef}
                onChange={handleImportChange}
                className="hidden"
              />
            </div>
          </div>
        );
      }

      // ----- Summary (overall) -----
      function Summary({ expenses, fxRates, fxLoading, fxError }) {
        if (expenses.length === 0) {
          return (
            <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 text-sm text-slate-500">
              No expenses match the current filters.
            </div>
          );
        }

        // Total in USD
        const totalUSD = expenses.reduce((acc, e) => {
          const usd = toUSD(
            e.amount,
            e.currency,
            fxRates,
            e.manualRateToUSD || null
          );
          return acc + (usd || 0);
        }, 0);

        // Totals by category (in USD)
        const byCategoryUSD = expenses.reduce((acc, e) => {
          const usd = toUSD(
            e.amount,
            e.currency,
            fxRates,
            e.manualRateToUSD || null
          );
          if (!usd) return acc;
          if (!acc[e.category]) acc[e.category] = 0;
          acc[e.category] += usd;
          return acc;
        }, {});

        const sortedByCategory = Object.entries(byCategoryUSD).sort(
          (a, b) => b[1] - a[1]
        );

        // Totals by native currency
        const byCurrency = expenses.reduce((acc, e) => {
          const code = normalizeCurrency(e.currency);
          if (!code) return acc;
          if (!acc[code]) acc[code] = 0;
          acc[code] += Number(e.amount) || 0;
          return acc;
        }, {});

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="md:col-span-1">
              <h2 className="text-lg font-semibold text-slate-800 mb-2">
                Total (converted to USD)
              </h2>
              <p className="text-3xl font-bold text-slate-900">
                {totalUSD.toFixed(2)}{" "}
                <span className="text-base font-medium text-slate-500">
                  USD
                </span>
              </p>
              <p className="mt-1 text-xs text-slate-500">
                ({expenses.length} expense{expenses.length !== 1 ? "s" : ""})
              </p>
              <div className="mt-2 text-xs text-slate-500">
                {fxLoading && <div>Fetching live FX rates…</div>}
                {fxError && <div className="text-amber-700">{fxError}</div>}
                {!fxLoading && !fxError && (
                  <div>
                    Using live FX rates (base: USD) from frankfurter.app and
                    manual overrides where provided.
                  </div>
                )}
              </div>
            </div>

            <div className="md:col-span-1">
              <h3 className="text-sm font-semibold text-slate-700 mb-2">
                By Category (USD)
              </h3>
              <div className="grid grid-cols-1 gap-2">
                {sortedByCategory.map(([cat, value]) => (
                  <div
                    key={cat}
                    className="flex items-center justify-between text-sm bg-slate-50 rounded-xl px-3 py-2"
                  >
                    <span className="text-slate-700">{cat}</span>
                    <span className="font-medium text-slate-900">
                      {value.toFixed(2)} USD
                    </span>
                  </div>
                ))}
                {sortedByCategory.length === 0 && (
                  <div className="text-xs text-slate-500">
                    Some entries have no FX data or manual rate; their USD
                    values are excluded.
                  </div>
                )}
              </div>
            </div>

            <div className="md:col-span-1">
              <h3 className="text-sm font-semibold text-slate-700 mb-2">
                Totals by Native Currency
              </h3>
              <div className="grid grid-cols-1 gap-2">
                {Object.entries(byCurrency).map(([code, value]) => (
                  <div
                    key={code}
                    className="flex items-center justify-between text-sm bg-slate-50 rounded-xl px-3 py-2"
                  >
                    <span className="text-slate-700">{code}</span>
                    <span className="font-medium text-slate-900">
                      {value.toFixed(2)} {code}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      // ----- Monthly Report -----
      function MonthlyReport({ expenses, fxRates }) {
        if (!expenses || expenses.length === 0) return null;

        const byMonth = useMemo(() => {
          const map = {};
          expenses.forEach((e) => {
            const d = dayjs(e.date);
            const key = d.isValid() ? d.format("YYYY-MM") : "Unknown";
            if (!map[key]) map[key] = [];
            map[key].push(e);
          });
          return map;
        }, [expenses]);

        const monthKeys = Object.keys(byMonth).sort(); // ascending

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6">
            <h2 className="text-lg font-semibold text-slate-800 mb-3">
              Monthly Report (USD)
            </h2>
            <p className="text-xs text-slate-500 mb-3">
              Based on the currently filtered expenses.
            </p>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {monthKeys.map((monthKey) => {
                const list = byMonth[monthKey];
                const totalUSD = list.reduce((acc, e) => {
                  const usd = toUSD(
                    e.amount,
                    e.currency,
                    fxRates,
                    e.manualRateToUSD || null
                  );
                  return acc + (usd || 0);
                }, 0);

                const byCategoryUSD = list.reduce((acc, e) => {
                  const usd = toUSD(
                    e.amount,
                    e.currency,
                    fxRates,
                    e.manualRateToUSD || null
                  );
                  if (!usd) return acc;
                  if (!acc[e.category]) acc[e.category] = 0;
                  acc[e.category] += usd;
                  return acc;
                }, {});

                const catEntries = Object.entries(byCategoryUSD).sort(
                  (a, b) => b[1] - a[1]
                );
                const maxValue =
                  catEntries.length > 0
                    ? Math.max(...catEntries.map(([, v]) => v))
                    : 0;

                const label =
                  monthKey === "Unknown"
                    ? "Unknown"
                    : dayjs(monthKey + "-01").isValid()
                    ? dayjs(monthKey + "-01").format("MMMM YYYY")
                    : monthKey;

                return (
                  <div
                    key={monthKey}
                    className="border border-slate-200 rounded-xl p-3 text-xs"
                  >
                    <div className="flex items-center justify-between mb-2">
                      <div className="font-semibold text-slate-800">
                        {label}
                      </div>
                      <div className="font-bold text-slate-900">
                        {totalUSD.toFixed(2)} USD
                      </div>
                    </div>
                    {catEntries.length === 0 ? (
                      <div className="text-slate-500">
                        No FX data/manual rate; cannot compute category split.
                      </div>
                    ) : (
                      <div className="space-y-1">
                        {catEntries.map(([cat, val]) => {
                          const percent =
                            maxValue > 0 ? (val / maxValue) * 100 : 0;
                          return (
                            <div key={cat}>
                              <div className="flex justify-between mb-0.5">
                                <span className="text-slate-700">{cat}</span>
                                <span className="text-slate-900">
                                  {val.toFixed(2)} USD
                                </span>
                              </div>
                              <div className="h-2 rounded-full bg-slate-200 overflow-hidden">
                                <div
                                  className="h-2 rounded-full bg-slate-500"
                                  style={{ width: `${percent}%` }}
                                ></div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      // ----- Tournament Dashboard (Tournament Mode) -----
      function TournamentDashboard({ expenses, fxRates }) {
        const tournamentExpenses = useMemo(
          () => expenses.filter((e) => e.tripType === "Tournament"),
          [expenses]
        );

        if (tournamentExpenses.length === 0) {
          return (
            <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 text-sm text-slate-500">
              No tournament expenses found (Type = Tournament). Use the Type
              field when adding expenses to enable Tournament Mode.
            </div>
          );
        }

        // Group by tournament (trip name)
        const byTournament = {};
        tournamentExpenses.forEach((e) => {
          const key = e.trip || "Unspecified Tournament";
          if (!byTournament[key]) byTournament[key] = [];
          byTournament[key].push(e);
        });

        const tournamentKeys = Object.keys(byTournament).sort();

        // Region comparison
        const byRegion = {};
        tournamentKeys.forEach((tKey) => {
          const list = byTournament[tKey];
          const region = (list[0].region || "Unspecified");
          const totalUSD = list.reduce((acc, e) => {
            const usd = toUSD(
              e.amount,
              e.currency,
              fxRates,
              e.manualRateToUSD || null
            );
            return acc + (usd || 0);
          }, 0);
          if (!byRegion[region]) {
            byRegion[region] = { totalUSD: 0, tournaments: 0 };
          }
          byRegion[region].totalUSD += totalUSD;
          byRegion[region].tournaments += 1;
        });

        const regionRows = Object.entries(byRegion).map(([region, data]) => {
          const avg =
            data.tournaments > 0 ? data.totalUSD / data.tournaments : 0;
          return {
            region,
            totalUSD: data.totalUSD,
            tournaments: data.tournaments,
            avgUSD: avg
          };
        });

        regionRows.sort((a, b) => b.totalUSD - a.totalUSD);

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6">
            <h2 className="text-lg font-semibold text-slate-800 mb-2">
              Tournament Mode – Per Tournament & Region Comparison
            </h2>
            <p className="text-xs text-slate-500 mb-3">
              Grouping expenses where <strong>Type = Tournament</strong>.
              Region can be set when adding tournament expenses (US, Europe,
              Asia, etc.).
            </p>

            {/* Region comparison */}
            <div className="mb-4">
              <h3 className="text-sm font-semibold text-slate-700 mb-2">
                Cost by Region (USD)
              </h3>
              <div className="overflow-x-auto">
                <table className="min-w-full text-xs">
                  <thead>
                    <tr className="border-b border-slate-200 text-left text-[10px] uppercase text-slate-500">
                      <th className="py-1 pr-3">Region</th>
                      <th className="py-1 pr-3 text-right">Total (USD)</th>
                      <th className="py-1 pr-3 text-right">Tournaments</th>
                      <th className="py-1 pr-3 text-right">Avg / Tournament</th>
                    </tr>
                  </thead>
                  <tbody>
                    {regionRows.map((row) => (
                      <tr
                        key={row.region}
                        className="border-b border-slate-100"
                      >
                        <td className="py-1 pr-3 whitespace-nowrap">
                          {row.region}
                        </td>
                        <td className="py-1 pr-3 text-right">
                          {row.totalUSD.toFixed(2)}
                        </td>
                        <td className="py-1 pr-3 text-right">
                          {row.tournaments}
                        </td>
                        <td className="py-1 pr-3 text-right">
                          {row.avgUSD.toFixed(2)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Per tournament cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {tournamentKeys.map((tKey) => {
                const list = byTournament[tKey];
                const totalUSD = list.reduce((acc, e) => {
                  const usd = toUSD(
                    e.amount,
                    e.currency,
                    fxRates,
                    e.manualRateToUSD || null
                  );
                  return acc + (usd || 0);
                }, 0);

                const region =
                  list[0].region && list[0].region.length > 0
                    ? list[0].region
                    : "Unspecified";

                const byCategoryUSD = list.reduce((acc, e) => {
                  const usd = toUSD(
                    e.amount,
                    e.currency,
                    fxRates,
                    e.manualRateToUSD || null
                  );
                  if (!usd) return acc;
                  if (!acc[e.category]) acc[e.category] = 0;
                  acc[e.category] += usd;
                  return acc;
                }, {});

                const catEntries = Object.entries(byCategoryUSD).sort(
                  (a, b) => b[1] - a[1]
                );
                const maxValue =
                  catEntries.length > 0
                    ? Math.max(...catEntries.map(([, v]) => v))
                    : 0;

                // native currency totals per tournament (useful if mixed)
                const nativeByCurrency = list.reduce((acc, e) => {
                  const code = normalizeCurrency(e.currency);
                  if (!code) return acc;
                  if (!acc[code]) acc[code] = 0;
                  acc[code] += Number(e.amount) || 0;
                  return acc;
                }, {});

                const receiptCount = list.reduce(
                  (acc, e) => acc + (e.receipts ? e.receipts.length : 0),
                  0
                );

                return (
                  <div
                    key={tKey}
                    className="border border-slate-200 rounded-xl p-3 text-xs"
                  >
                    <div className="flex items-center justify-between mb-2">
                      <div>
                        <div className="font-semibold text-slate-800">
                          {tKey}
                        </div>
                        <div className="text-[11px] text-slate-500">
                          Region: {region} · {list.length} expense
                          {list.length !== 1 ? "s" : ""} · Receipts:{" "}
                          {receiptCount}
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-[11px] text-slate-500">
                          Total (USD)
                        </div>
                        <div className="font-bold text-slate-900">
                          {totalUSD.toFixed(2)}
                        </div>
                      </div>
                    </div>

                    {/* Native currency summary */}
                    <div className="mb-2 text-[11px] text-slate-600">
                      {Object.keys(nativeByCurrency).length > 0 && (
                        <div>
                          Native totals:&nbsp;
                          {Object.entries(nativeByCurrency)
                            .map(
                              ([code, val]) =>
                                `${val.toFixed(2)} ${code}`
                            )
                            .join(" · ")}
                        </div>
                      )}
                    </div>

                    {/* Category mini bars */}
                    {catEntries.length === 0 ? (
                      <div className="text-slate-500">
                        No FX data/manual rate; cannot compute category split.
                      </div>
                    ) : (
                      <div className="space-y-1">
                        {catEntries.map(([cat, val]) => {
                          const percent =
                            maxValue > 0 ? (val / maxValue) * 100 : 0;
                          return (
                            <div key={cat}>
                              <div className="flex justify-between mb-0.5">
                                <span className="text-slate-700">{cat}</span>
                                <span className="text-slate-900">
                                  {val.toFixed(2)} USD
                                </span>
                              </div>
                              <div className="h-2 rounded-full bg-slate-200 overflow-hidden">
                                <div
                                  className="h-2 rounded-full bg-slate-500"
                                  style={{ width: `${percent}%` }}
                                ></div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      // ----- Expense Table -----
      function ExpenseTable({ expenses, onDelete, fxRates }) {
        if (expenses.length === 0) return null;

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-10">
            <h2 className="text-lg font-semibold text-slate-800 mb-3">
              Expenses
            </h2>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="border-b border-slate-200 text-left text-xs uppercase text-slate-500">
                    <th className="py-2 pr-4">Date</th>
                    <th className="py-2 pr-4">Type</th>
                    <th className="py-2 pr-4">
                      Tournament / Location / Event
                    </th>
                    <th className="py-2 pr-4">Region</th>
                    <th className="py-2 pr-4">Category</th>
                    <th className="py-2 pr-4 text-right">Amount</th>
                    <th className="py-2 pr-4">Payer</th>
                    <th className="py-2 pr-4">Receipts</th>
                    <th className="py-2 pr-4">Notes</th>
                    <th className="py-2 pr-4"></th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.map((e) => {
                    const usdValue = toUSD(
                      e.amount,
                      e.currency,
                      fxRates,
                      e.manualRateToUSD || null
                    );
                    return (
                      <tr
                        key={e.id}
                        className="border-b border-slate-100 hover:bg-slate-50"
                      >
                        <td className="py-2 pr-4 whitespace-nowrap">
                          {e.date}
                        </td>
                        <td className="py-2 pr-4 whitespace-nowrap">
                          {e.tripType || "-"}
                        </td>
                        <td className="py-2 pr-4 whitespace-nowrap">
                          {e.trip || "-"}
                        </td>
                        <td className="py-2 pr-4 whitespace-nowrap">
                          {e.region || "-"}
                        </td>
                        <td className="py-2 pr-4 whitespace-nowrap">
                          {e.category}
                        </td>
                        <td className="py-2 pr-4 text-right whitespace-nowrap align-top">
                          <div>
                            {e.amount.toFixed(2)} {normalizeCurrency(e.currency)}
                            {e.subAmounts && e.subAmounts.length > 1 && (
                              <span className="text-xs text-slate-500 ml-1">
                                ({e.subAmounts.length} items)
                              </span>
                            )}
                          </div>
                          {usdValue != null &&
                            normalizeCurrency(e.currency) !== "USD" && (
                              <div className="text-xs text-slate-500">
                                ≈ {usdValue.toFixed(2)} USD
                              </div>
                            )}
                        </td>
                        <td className="py-2 pr-4 whitespace-nowrap">
                          {e.payer}
                        </td>
                        <td className="py-2 pr-4 whitespace-nowrap">
                          {e.receipts && e.receipts.length > 0 ? (
                            <div className="flex items-center gap-1">
                              {e.receipts.slice(0, 3).map((r) =>
                                r.type && r.type.startsWith("image/") ? (
                                  <a
                                    key={r.id}
                                    href={r.dataUrl}
                                    target="_blank"
                                    rel="noreferrer"
                                  >
                                    <img
                                      src={r.dataUrl}
                                      alt={r.name}
                                      className="w-8 h-8 rounded object-cover border border-slate-200"
                                      title={r.name}
                                    />
                                  </a>
                                ) : (
                                  <a
                                    key={r.id}
                                    href={r.dataUrl}
                                    target="_blank"
                                    rel="noreferrer"
                                    className="px-1.5 py-0.5 rounded border border-slate-300 text-[10px] text-slate-700"
                                  >
                                    PDF
                                  </a>
                                )
                              )}
                              {e.receipts.length > 3 && (
                                <span className="text-[10px] text-slate-500">
                                  +{e.receipts.length - 3} more
                                </span>
                              )}
                            </div>
                          ) : (
                            <span className="text-xs text-slate-400">
                              None
                            </span>
                          )}
                        </td>
                        <td className="py-2 pr-4 max-w-xs">
                          <span className="line-clamp-2">{e.notes}</span>
                        </td>
                        <td className="py-2 pr-4 text-right">
                          <button
                            onClick={() => {
                              if (
                                window.confirm(
                                  "Delete this expense? This cannot be undone."
                                )
                              ) {
                                onDelete(e.id);
                              }
                            }}
                            className="text-xs text-red-600 hover:text-red-700"
                          >
                            Delete
                          </button>
                        </td>
                      </tr>
                    );
                  })}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      // ----- App -----
      function App() {
        const [expenses, setExpenses] = useState([]);
        const [filters, setFilters] = useState({
          fromDate: "",
          toDate: "",
          trip: "",
          category: ""
        });

        const [fxRates, setFxRates] = useState(null);
        const [fxLoading, setFxLoading] = useState(false);
        const [fxError, setFxError] = useState(null);

        useEffect(() => {
          setExpenses(loadExpenses());
        }, []);

        useEffect(() => {
          saveExpenses(expenses);
        }, [expenses]);

        // Fetch live FX rates (base USD) from frankfurter.app
        useEffect(() => {
          async function fetchFx() {
            try {
              setFxLoading(true);
              setFxError(null);

              const symbols = FX_SUPPORTED.filter((c) => c !== "USD").join(",");
              const url = `https://api.frankfurter.app/latest?from=USD&to=${symbols}`;

              const res = await fetch(url);
              if (!res.ok) {
                throw new Error("Network error fetching FX");
              }
              const data = await res.json();
              if (!data || !data.rates) {
                throw new Error("Invalid FX data");
              }
              setFxRates(data.rates);
            } catch (err) {
              console.error("FX fetch failed:", err);
              setFxError(
                "Unable to fetch live FX rates. USD totals may exclude some currencies unless manual rates are provided."
              );
              setFxRates(null);
            } finally {
              setFxLoading(false);
            }
          }

          fetchFx();
        }, []);

        function handleAddExpense(exp) {
          setExpenses((prev) =>
            [...prev, exp].sort((a, b) => a.date.localeCompare(b.date))
          );
        }

        function handleDelete(id) {
          setExpenses((prev) => prev.filter((e) => e.id !== id));
        }

        const allTrips = useMemo(() => {
          const s = new Set();
          expenses.forEach((e) => {
            if (e.trip) s.add(e.trip);
          });
          return Array.from(s).sort();
        }, [expenses]);

        const filteredExpenses = useMemo(() => {
          return expenses.filter((e) => {
            if (filters.fromDate && e.date < filters.fromDate) return false;
            if (filters.toDate && e.date > filters.toDate) return false;
            if (filters.trip && e.trip !== filters.trip) return false;
            if (filters.category && e.category !== filters.category)
              return false;
            return true;
          });
        }, [expenses, filters]);

        function handleRestoreFromBackup(importedExpenses) {
          // Basic sanity: ensure each item has at least id/date/amount
          const cleaned = (importedExpenses || []).map((e) => ({
            id: e.id || uuid(),
            date: e.date || dayjs().format("YYYY-MM-DD"),
            trip: e.trip || "",
            tripType: e.tripType || "",
            region: e.region || "",
            category: e.category || "Other",
            amount: Number(e.amount) || 0,
            subAmounts: Array.isArray(e.subAmounts) ? e.subAmounts : [],
            currency: normalizeCurrency(e.currency || "USD"),
            manualRateToUSD:
              typeof e.manualRateToUSD === "number"
                ? e.manualRateToUSD
                : null,
            payer: e.payer || "Athlete",
            notes: e.notes || "",
            receipts: Array.isArray(e.receipts) ? e.receipts : []
          }));
          cleaned.sort((a, b) => a.date.localeCompare(b.date));
          setExpenses(cleaned);
        }

        return (
          <div className="min-h-screen">
            <header className="bg-slate-900 text-white py-4">
              <div className="max-w-5xl mx-auto px-4 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                  <h1 className="text-2xl font-semibold">
                    Athlete Expense Tracker
                  </h1>
                  <p className="text-xs text-slate-300">
                    Multi-currency tracking with receipts, exports, tournaments & reports
                  </p>
                </div>
              </div>
            </header>

            <main className="max-w-5xl mx-auto px-4 py-6">
              <ExpenseForm onAdd={handleAddExpense} />
              <Filters
                filters={filters}
                onChange={setFilters}
                trips={allTrips}
              />
              <BackupPanel
                expenses={expenses}
                onRestore={handleRestoreFromBackup}
              />
              <ExportPanel expenses={filteredExpenses} fxRates={fxRates} />
              <Summary
                expenses={filteredExpenses}
                fxRates={fxRates}
                fxLoading={fxLoading}
                fxError={fxError}
              />
              <MonthlyReport expenses={filteredExpenses} fxRates={fxRates} />
              <TournamentDashboard
                expenses={filteredExpenses}
                fxRates={fxRates}
              />
              <ExpenseTable
                expenses={filteredExpenses}
                onDelete={handleDelete}
                fxRates={fxRates}
              />
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
