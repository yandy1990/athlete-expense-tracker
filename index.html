<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Athlete Expense Tracker (Supabase)</title>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Day.js for dates -->
    <script src="https://unpkg.com/dayjs@1.11.11/dayjs.min.js"></script>

    <!-- Supabase JS (v2) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Babel for JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>

  <body class="bg-slate-100">
    <div id="root"></div>

    <!-- Our app code (JSX) -->
    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect } = React;

      // TODO: ðŸ”´ Replace these two with your real values from Supabase Settings â†’ API
      const SUPABASE_URL = "https://jpyukcuwmokvhvvcxuot.supabase.co"; // e.g. "https://abcd1234.supabase.co"
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweXVrY3V3bW9rdmh2dmN4dW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NDczMTcsImV4cCI6MjA4MDEyMzMxN30.TAElhnXbFm1nyvqpQNiyQTcQUPSltcKtr2Ul8VSxBhg";

      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const CATEGORIES = [
        "Accommodations",
        "Food & Meals",
        "Car / Transport",
        "Travel (Flights / Train)",
        "Tennis Coaching Fee",
        "Fitness Coaching Fee",
        "Physio Fee",
        "Medical Expenses",
        "Equipment",
        "Other"
      ];

      const PAYERS = ["Athlete", "Parent", "Team", "Sponsor", "Other"];

      const CONTEXT_TYPES = ["Tournament", "Training", "Event"];

      function normalizeCurrency(code) {
        if (!code) return "";
        return code.toUpperCase();
      }

      // ---------- Auth Wrapper ----------

      function AuthGate({ children }) {
        const [session, setSession] = useState(null);
        const [loading, setLoading] = useState(true);
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");
        const [mode, setMode] = useState("login"); // "login" or "signup"

        useEffect(() => {
          // initial session check
          supabaseClient.auth.getSession().then(({ data }) => {
            setSession(data.session);
            setLoading(false);
          });

          // listen for changes
          const { data: listener } = supabaseClient.auth.onAuthStateChange(
            (_event, session) => {
              setSession(session);
            }
          );

          return () => {
            listener.subscription.unsubscribe();
          };
        }, []);

        async function handleLogin(e) {
          e.preventDefault();
          if (!email || !password) {
            alert("Please enter email and password.");
            return;
          }

          const { error } = await supabaseClient.auth.signInWithPassword({
            email,
            password
          });

          if (error) {
            alert("Login error: " + error.message);
          }
        }

        async function handleSignup(e) {
          e.preventDefault();
          if (!email || !password) {
            alert("Please enter email and password.");
            return;
          }

          const { error } = await supabaseClient.auth.signUp({
            email,
            password
          });

          if (error) {
            alert("Signup error: " + error.message);
            return;
          }

          alert("Signup successful. Depending on settings, you may need to verify your email.");
        }

        async function handleLogout() {
          await supabaseClient.auth.signOut();
        }

        if (loading) {
          return (
            <div className="min-h-screen flex items-center justify-center text-slate-600 text-sm">
              Connecting to Supabase...
            </div>
          );
        }

        if (!session) {
          // Not logged in
          return (
            <div className="min-h-screen flex items-center justify-center px-4">
              <div className="max-w-md w-full bg-white rounded-2xl shadow p-6">
                <h1 className="text-xl font-semibold text-slate-900 mb-1">
                  Athlete Expense Tracker
                </h1>
                <p className="text-xs text-slate-500 mb-4">
                  Log in or sign up to start tracking expenses across devices.
                </p>

                <div className="flex text-xs mb-3 border border-slate-200 rounded-xl overflow-hidden">
                  <button
                    className={
                      "flex-1 px-3 py-2 " +
                      (mode === "login"
                        ? "bg-slate-900 text-white"
                        : "bg-white text-slate-700")
                    }
                    onClick={() => setMode("login")}
                    type="button"
                  >
                    Log in
                  </button>
                  <button
                    className={
                      "flex-1 px-3 py-2 " +
                      (mode === "signup"
                        ? "bg-slate-900 text-white"
                        : "bg-white text-slate-700")
                    }
                    onClick={() => setMode("signup")}
                    type="button"
                  >
                    Sign up
                  </button>
                </div>

                <form className="space-y-3" onSubmit={mode === "login" ? handleLogin : handleSignup}>
                  <div>
                    <label className="block text-xs font-medium text-slate-700 mb-1">
                      Email
                    </label>
                    <input
                      type="email"
                      value={email}
                      onChange={(e) => setEmail(e.target.value)}
                      className="w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-slate-700 mb-1">
                      Password
                    </label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      className="w-full border border-slate-300 rounded-xl px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                    />
                  </div>

                  <button
                    type="submit"
                    className="w-full mt-1 px-3 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800"
                  >
                    {mode === "login" ? "Log in" : "Sign up"}
                  </button>
                </form>

                <p className="mt-3 text-[10px] text-slate-500">
                  Data is stored in Supabase under your account, not in this browser only.
                </p>
              </div>
            </div>
          );
        }

        // Logged in: render the app
        return (
          <div className="min-h-screen flex flex-col">
            <header className="bg-slate-900 text-white py-3">
              <div className="max-w-5xl mx-auto px-4 flex items-center justify-between text-xs">
                <div>
                  <div className="font-semibold text-sm">Athlete Expense Tracker</div>
                  <div className="text-slate-300">
                    Signed in as {session.user.email}
                  </div>
                </div>
                <button
                  onClick={handleLogout}
                  className="px-3 py-1 rounded-xl bg-slate-700 text-[11px] hover:bg-slate-600"
                >
                  Log out
                </button>
              </div>
            </header>

            {children(session)}
          </div>
        );
      }

      // ---------- Expense Form ----------

      function ExpenseForm({ onAdd }) {
        const today = dayjs().format("YYYY-MM-DD");
        const [date, setDate] = useState(today);
        const [tripType, setTripType] = useState("Tournament");
        const [trip, setTrip] = useState("");
        const [category, setCategory] = useState(CATEGORIES[0]);
        const [amount, setAmount] = useState("");
        const [currency, setCurrency] = useState("USD");
        const [payer, setPayer] = useState(PAYERS[0]);
        const [notes, setNotes] = useState("");

        const normalizedCurrency = normalizeCurrency(currency);

        function handleSubmit(e) {
          e.preventDefault();
          const num = Number(amount);
          if (isNaN(num) || num <= 0) {
            alert("Please enter a positive amount.");
            return;
          }

          const exp = {
            date,
            trip: trip.trim(),
            tripType,
            category,
            amount: num,
            currency: normalizedCurrency || "USD",
            payer,
            notes: notes.trim()
          };

          onAdd(exp);

          // reset amount & notes, keep other context
          setAmount("");
          setNotes("");
        }

        const contextLabel =
          tripType === "Tournament"
            ? "Tournament Name"
            : tripType === "Training"
            ? "Training Location (City)"
            : "Event Name";

        const contextPlaceholder =
          tripType === "Tournament"
            ? "e.g., 2025 Australian Open"
            : tripType === "Training"
            ? "e.g., Barcelona"
            : "e.g., Sponsor shoot â€“ Nike";

        return (
          <form
            onSubmit={handleSubmit}
            className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 grid grid-cols-1 md:grid-cols-2 gap-4"
          >
            <h2 className="md:col-span-2 text-lg font-semibold text-slate-800">
              Add Expense
            </h2>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Date
              </label>
              <input
                type="date"
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                required
              />
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Type
              </label>
              <select
                value={tripType}
                onChange={(e) => setTripType(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {CONTEXT_TYPES.map((t) => (
                  <option key={t} value={t}>
                    {t}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                {contextLabel}
              </label>
              <input
                type="text"
                placeholder={contextPlaceholder}
                value={trip}
                onChange={(e) => setTrip(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              />
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Category
              </label>
              <select
                value={category}
                onChange={(e) => setCategory(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {CATEGORIES.map((c) => (
                  <option key={c} value={c}>
                    {c}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Amount
              </label>
              <input
                type="number"
                step="0.01"
                min="0"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                placeholder="e.g., 120.50"
              />
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Currency
              </label>
              <input
                type="text"
                value={currency}
                onChange={(e) => setCurrency(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm uppercase focus:outline-none focus:ring-2 focus:ring-slate-500"
                placeholder="USD"
              />
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Paid By
              </label>
              <select
                value={payer}
                onChange={(e) => setPayer(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {PAYERS.map((p) => (
                  <option key={p} value={p}>
                    {p}
                  </option>
                ))}
              </select>
            </div>

            <div className="md:col-span-2">
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Notes
              </label>
              <textarea
                rows={2}
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                placeholder="Optional details"
              />
            </div>

            <div className="md:col-span-2 flex justify-end">
              <button
                type="submit"
                className="px-4 py-2 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800"
              >
                Save Expense
              </button>
            </div>
          </form>
        );
      }

      // ---------- Expense Table ----------

      function ExpenseTable({ expenses, onDelete }) {
        if (expenses.length === 0) {
          return (
            <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-10 text-sm text-slate-500">
              No expenses recorded yet.
            </div>
          );
        }

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-10">
            <h2 className="text-lg font-semibold text-slate-800 mb-3">
              Expenses
            </h2>
            <div className="overflow-x-auto">
              <table className="min-w-full text-sm">
                <thead>
                  <tr className="border-b border-slate-200 text-left text-xs uppercase text-slate-500">
                    <th className="py-2 pr-4">Date</th>
                    <th className="py-2 pr-4">Type</th>
                    <th className="py-2 pr-4">Tournament / Location / Event</th>
                    <th className="py-2 pr-4">Category</th>
                    <th className="py-2 pr-4 text-right">Amount</th>
                    <th className="py-2 pr-4">Currency</th>
                    <th className="py-2 pr-4">Payer</th>
                    <th className="py-2 pr-4">Notes</th>
                    <th className="py-2 pr-4"></th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.map((e) => (
                    <tr
                      key={e.id}
                      className="border-b border-slate-100 hover:bg-slate-50"
                    >
                      <td className="py-2 pr-4 whitespace-nowrap">{e.date}</td>
                      <td className="py-2 pr-4 whitespace-nowrap">
                        {e.trip_type || "-"}
                      </td>
                      <td className="py-2 pr-4 whitespace-nowrap">
                        {e.trip || "-"}
                      </td>
                      <td className="py-2 pr-4 whitespace-nowrap">
                        {e.category}
                      </td>
                      <td className="py-2 pr-4 text-right whitespace-nowrap">
                        {Number(e.amount).toFixed(2)}
                      </td>
                      <td className="py-2 pr-4 whitespace-nowrap">
                        {normalizeCurrency(e.currency)}
                      </td>
                      <td className="py-2 pr-4 whitespace-nowrap">
                        {e.payer || "-"}
                      </td>
                      <td className="py-2 pr-4 max-w-xs">
                        <span className="line-clamp-2 text-xs">{e.notes}</span>
                      </td>
                      <td className="py-2 pr-4 text-right">
                        <button
                          onClick={() => {
                            if (window.confirm("Delete this expense?")) {
                              onDelete(e.id);
                            }
                          }}
                          className="text-xs text-red-600 hover:text-red-700"
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

      // ---------- App (uses Supabase) ----------

      function App({ session }) {
        const [expenses, setExpenses] = useState([]);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          async function fetchExpenses() {
            setLoading(true);
            const { data, error } = await supabaseClient
              .from("expenses")
              .select("*")
              .eq("user_id", session.user.id)
              .order("date", { ascending: true });

            if (error) {
              console.error("Error loading expenses:", error);
              alert("Error loading expenses: " + error.message);
              setExpenses([]);
            } else {
              setExpenses(data || []);
            }
            setLoading(false);
          }

          fetchExpenses();
        }, [session.user.id]);

        async function handleAdd(exp) {
          const { data, error } = await supabaseClient
            .from("expenses")
            .insert({
              user_id: session.user.id,
              date: exp.date,
              trip: exp.trip,
              trip_type: exp.tripType,
              category: exp.category,
              amount: exp.amount,
              currency: exp.currency,
              payer: exp.payer,
              notes: exp.notes
            })
            .select()
            .single();

          if (error) {
            console.error("Error saving expense:", error);
            alert("Error saving expense: " + error.message);
            return;
          }

          setExpenses((prev) =>
            [...prev, data].sort((a, b) => a.date.localeCompare(b.date))
          );
        }

        async function handleDelete(id) {
          const { error } = await supabaseClient
            .from("expenses")
            .delete()
            .eq("id", id)
            .eq("user_id", session.user.id);

          if (error) {
            console.error("Error deleting expense:", error);
            alert("Error deleting expense: " + error.message);
            return;
          }

          setExpenses((prev) => prev.filter((e) => e.id !== id));
        }

        const totalAmount = expenses.reduce(
          (sum, e) => sum + Number(e.amount || 0),
          0
        );

        return (
          <main className="max-w-5xl mx-auto px-4 py-6 flex-1">
            <div className="mb-4 bg-white rounded-2xl shadow p-4 md:p-6">
              <h2 className="text-lg font-semibold text-slate-800 mb-1">
                Overview
              </h2>
              <p className="text-sm text-slate-500 mb-2">
                This version stores your data in Supabase so you can access it from any device using the same login.
              </p>
              <p className="text-xs text-slate-600">
                Total entries:{" "}
                <span className="font-semibold">{expenses.length}</span>{" "}
                Â· Total amount (raw, mixed currencies):{" "}
                <span className="font-semibold">
                  {totalAmount.toFixed(2)}
                </span>
              </p>
            </div>

            <ExpenseForm onAdd={handleAdd} />

            {loading ? (
              <div className="bg-white rounded-2xl shadow p-4 md:p-6 text-sm text-slate-500">
                Loading expenses...
              </div>
            ) : (
              <ExpenseTable expenses={expenses} onDelete={handleDelete} />
            )}
          </main>
        );
      }

      // ---------- Mount ----------

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(
        <AuthGate>
          {(session) => <App session={session} />}
        </AuthGate>
      );
    </script>
  </body>
</html>
