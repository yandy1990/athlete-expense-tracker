<!doctype html>
<html lang="en">
  <head>
    <link rel="manifest" href="manifest.json" />

    <!-- iOS home screen settings -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="Athlete Expenses" />
    <link rel="apple-touch-icon" href="icon-192.png" />

    <meta charset="UTF-8" />
    <title>Athlete Expense Tracker (Supabase + FX + Receipts)</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React -->
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.development.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
    ></script>

    <!-- Day.js -->
    <script src="https://unpkg.com/dayjs@1.11.11/dayjs.min.js"></script>

    <!-- Supabase JS v2 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- JSZip for backup ZIPs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Babel (JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>

  <body class="bg-slate-100">

    
    <!-- tennis court green
    
  <body class="min-h-screen flex items-center justify-center"
  style="
    background: linear-gradient(135deg, #dff3e4 0%, #b7e0c4 100%);
    background-size: cover;
    background-position: center;
    position: relative;
  "
>

    -->
    
    
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
      const { useState, useEffect, useMemo } = React;

      // ðŸ”´ Supabase credentials (same as you had)
      const SUPABASE_URL = "https://jpyukcuwmokvhvvcxuot.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpweXVrY3V3bW9rdmh2dmN4dW90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1NDczMTcsImV4cCI6MjA4MDEyMzMxN30.TAElhnXbFm1nyvqpQNiyQTcQUPSltcKtr2Ul8VSxBhg";

      const supabaseClient = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      const CATEGORIES = [
        "Accommodations",
        "Food & Meals",
        "Car / Transport",
        "Travel (Flights / Train)",
        "Tennis Coaching Fee",
        "Fitness Coaching Fee",
        "Physio Fee",
        "Medical Expenses",
        "Equipment",
        "Other Training Expenses",
        "Telecommunications",
        "Other Business Related Expense",
        "Other",
      ];

      const PAYERS = ["Athlete", "Parent", "Team", "Sponsor", "Coach", "Other"];

      const CONTEXT_TYPES = ["Tournament", "Training", "Event"];

      const REGION_OPTIONS = [
        "US",
        "Europe",
        "UK",
        "Asia",
        "Middle East",
        "South America",
        "Oceania",
        "Africa",
        "Other",
      ];

      const AUTO_FX_CURRENCIES = ["EUR", "GBP", "JPY", "AUD", "CAD"];
      const ALL_FX_KNOWN = ["USD", ...AUTO_FX_CURRENCIES];

      // ----- User Storage Quotas -----

function getStorageLimitBytes(plan) {
  // adjust for your free & paid tiers
  if (plan === "pro") {
    return 5 * 1024 * 1024 * 1024; // 5 GB
  }
  return 1 * 1024 * 1024 * 1024; // 200 MB default for free tier
}

function calcUsedStorageBytes(expenses) {
  let total = 0;
  for (const e of expenses || []) {
    if (Array.isArray(e.receipts)) {
      for (const r of e.receipts) {
        if (r && typeof r.size_bytes === "number") {
          total += r.size_bytes;
        }
      }
    }
  }
  return total;
}

      function normalizeCurrency(code) {
        if (!code) return "";
        const upper = code.toUpperCase();
        if (upper === "CND" || upper === "CAN") return "CAD";
        return upper;
      }

      // ----- CSV / file helpers -----
      function buildCSV(rows) {
        if (!rows || !rows.length) return "";
        const headers = Object.keys(rows[0]);
        const esc = (v) => {
          if (v === null || v === undefined) return '""';
          const s = String(v).replace(/"/g, '""');
          return `"${s}"`;
        };
        const lines = [];
        lines.push(headers.map((h) => `"${h}"`).join(","));
        for (const row of rows) {
          lines.push(headers.map((h) => esc(row[h])).join(","));
        }
        return lines.join("\r\n");
      }

      function downloadFile(filename, contents, mime) {
        const blob =
          contents instanceof Blob
            ? contents
            : new Blob([contents], { type: mime });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

            // ----- AuthGate -----
      function AuthGate({ children }) {
        const [session, setSession] = useState(null);
        const [loading, setLoading] = useState(true);

        const [mode, setMode] = useState("login");
        const [email, setEmail] = useState("");
        const [password, setPassword] = useState("");

        const [disclaimerAccepted, setDisclaimerAccepted] = useState(false);

        useEffect(() => {
          supabaseClient.auth.getSession().then(({ data }) => {
            const sess = data.session;
            setSession(sess);

            if (sess) {
              const accepted =
                window.localStorage.getItem(
                  "athlete_expense_disclaimer_v1"
                ) === "true";
              setDisclaimerAccepted(accepted);
            }

            setLoading(false);
          });

          const { data } = supabaseClient.auth.onAuthStateChange(
            (_event, sess) => {
              setSession(sess);
              if (sess) {
                const accepted =
                  window.localStorage.getItem(
                    "athlete_expense_disclaimer_v1"
                  ) === "true";
                setDisclaimerAccepted(accepted);
              } else {
                setDisclaimerAccepted(false);
              }
            }
          );
          return () => data.subscription.unsubscribe();
        }, []);

        async function handleLogin(e) {
          e.preventDefault();
          if (!email || !password) {
            alert("Enter email and password");
            return;
          }
          const { error } = await supabaseClient.auth.signInWithPassword({
            email,
            password,
          });
          if (error) alert("Login error: " + error.message);
        }

        async function handleSignup(e) {
          e.preventDefault();
          if (!email || !password) {
            alert("Enter email and password");
            return;
          }
          const { error } = await supabaseClient.auth.signUp({
            email,
            password,
          });
          if (error) {
            alert("Signup error: " + error.message);
            return;
          }
          alert(
            "Signup OK. You may need to verify your email depending on settings."
          );
        }

   async function handleLogout() {
  try {
    const { error } = await supabaseClient.auth.signOut();

    // If Supabase says "Auth session missing!", treat it as already logged out
    if (error && !String(error.message).includes("Auth session missing")) {
      console.error("Logout error:", error);
      alert("Logout error: " + error.message);
      return;
    }

    // Clear session in UI
    setSession(null);

    // Force a full reload so the app comes back in logged-out state
    window.location.reload();
  } catch (err) {
    console.error("Unexpected logout error:", err);
    alert("Unexpected logout error: " + (err.message || err));
  }
}

        function handleAcceptDisclaimer() {
          window.localStorage.setItem(
            "athlete_expense_disclaimer_v1",
            "true"
          );
          setDisclaimerAccepted(true);
        }


function handleFeedbackScroll() {
  const el = document.getElementById("feedback-section");
  if (el) {
    el.scrollIntoView({ behavior: "smooth", block: "start" });
  }
}


        if (loading) {
          return (
            <div className="min-h-screen flex items-center justify-center text-slate-600 text-sm">
              Connecting to Supabase...
            </div>
          );
        }

        // Not logged in yet -> show auth form
        if (!session) {
          return (
 <div className="min-h-screen w-full flex items-center justify-center px-4 bg-slate-50">
      <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8">
        <div className="mb-5 text-center">
          <h1 className="text-2xl font-bold text-slate-900 tracking-tight mb-1">
            Athlete Expense Tracker
          </h1>

          <p className="text-sm font-medium text-slate-700 mb-2">
            Log in or sign up to sync expenses across devices.
          </p>

          <p className="text-[14px] font-medium text-emerald-600 mb-2">
            Free â€” no credit card required. Just an email to sign up.
          </p>

          <p className="text-[14px] font-medium text-emerald-600 mb-2">
            100% private â€” you control your data.
          </p>
        </div>

        <div className="flex text-xs mb-4 border border-slate-200 rounded-xl overflow-hidden">
          <button
            type="button"
            onClick={() => setMode("login")}
            className={
              "flex-1 px-4 py-2.5 " +
              (mode === "login"
                ? "bg-slate-900 text-white"
                : "bg-white text-slate-600")
            }
          >
            Log in
          </button>

          <button
            type="button"
            onClick={() => setMode("signup")}
            className={
              "flex-1 px-4 py-2.5 " +
              (mode === "signup"
                ? "bg-slate-900 text-white"
                : "bg-white text-slate-600")
            }
          >
            Sign up
          </button>
        </div>

        <form
          className="space-y-4"
          onSubmit={mode === "login" ? handleLogin : handleSignup}
        >
          <div>
            <label className="block text-xs font-medium text-slate-700 mb-1">
              Email
            </label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full border border-slate-300 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              placeholder="you@example.com"
            />
          </div>

          <div>
            <label className="block text-xs font-medium text-slate-700 mb-1">
              Password
            </label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full border border-slate-300 rounded-xl px-3 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              placeholder="Enter your password"
            />
          </div>

          <button
            type="submit"
            className="w-full mt-2 px-4 py-2.5 rounded-xl bg-slate-900 text-white text-sm font-semibold hover:bg-slate-800 transition"
          >
            {mode === "login" ? "Log in" : "Sign up"}
          </button>
        </form>

<p className="mt-4 text-[14px] text-slate-600 text-center tracking-wide">
  <span className="italic">Powered by</span>{" "}
  <span className="font-semibold text-slate-600">
    bacKHand tennis<sup>Â®</sup> 
  </span>
</p>


        <p className="mt-4 text-[10px] text-slate-400 text-center">
          Data stored securely with Supabase. We never share or sell your data.
        </p>
      </div>
    </div>
          );
        }

        // Logged in but disclaimer not yet accepted -> show disclaimer screen
        if (session && !disclaimerAccepted) {
          return (
            <div className="min-h-screen flex items-center justify-center px-4 bg-slate-100">
              <div className="max-w-lg w-full bg-white rounded-2xl shadow p-6 text-sm">
                <h1 className="text-xl font-semibold text-slate-900 mb-2">
                  Legal Disclaimer
                </h1>
                <p className="text-xs text-slate-500 mb-4">
                  This athlete expense tracker is provided on a best-effort
                  basis. While we use Supabase and common security practices,
                  <span className="font-semibold">
                    {" "}
                    there is no guarantee against data loss, corruption, or
                    unauthorized access.
                  </span>
                </p>
                <ul className="list-disc pl-4 text-xs text-slate-600 mb-4 space-y-1">
                  <li>
                    You are responsible for keeping your login credentials
                    secure.
                  </li>
                  <li>
                    You should keep your own independent backups of any critical
                    financial or tax records.
                  </li>
                  <li>
                    By continuing, you accept that if data stored in this system
                    is lost, unavailable, or accessed by third parties,{" "}
                    <span className="font-semibold">
                      you use it at your own risk and the operator of this tool
                      is not liable for any resulting loss or damage.
                    </span>
                  </li>
                </ul>
                <div className="flex justify-end gap-2 mt-4">
                  <button
                    onClick={handleLogout}
                    className="px-3 py-2 rounded-xl border border-slate-300 text-xs text-slate-600 hover:bg-slate-50"
                  >
                    Log out
                  </button>
                  <button
                    onClick={handleAcceptDisclaimer}
                    className="px-4 py-2 rounded-xl bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800"
                  >
                    I understand &amp; accept
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // Logged in & disclaimer accepted -> normal app
        return (
          <div className="min-h-screen flex flex-col">
            <header className="bg-slate-900 text-white py-3">
              <div className="max-w-5xl mx-auto px-4 flex items-center justify-between text-xs">
                <div>
                  <div className="font-semibold text-sm">
                    Athlete Expense Tracker
                  </div>
                  <div className="text-slate-300">
                    Signed in as {session.user.email}
                  </div>
                </div>

<div className="flex items-center gap-2">
      <button
        type="button"
        onClick={handleFeedbackScroll}
        className="px-3 py-1 rounded-xl bg-slate-700 text-[11px] hover:bg-slate-600"
      >
        Feedback
      </button>

                <button
                  onClick={handleLogout}
                  className="px-3 py-1 rounded-xl bg-slate-700 text-[11px] hover:bg-slate-600"
                >
                  Log out
                </button>
              </div>
 </div>

            </header>
            {children(session)}
          </div>
        );
      }

      // ----- Expense Form -----
      function ExpenseForm({ onAdd, saving }) {
        const today = dayjs().format("YYYY-MM-DD");
        const [date, setDate] = useState(today);
        const [tripType, setTripType] = useState("Tournament");
        const [trip, setTrip] = useState("");
        const [region, setRegion] = useState("");
        const [category, setCategory] = useState(CATEGORIES[0]);
        const [amount, setAmount] = useState("");
        const [currency, setCurrency] = useState("USD");
        const [manualRate, setManualRate] = useState("");
        const [payer, setPayer] = useState(PAYERS[0]);
        const [notes, setNotes] = useState("");
        const [receiptFiles, setReceiptFiles] = useState([]);

        const normCurrency = normalizeCurrency(currency);
        const autoFX = AUTO_FX_CURRENCIES.includes(normCurrency);
        const knownFX = ALL_FX_KNOWN.includes(normCurrency);

        const contextLabel =
          tripType === "Tournament"
            ? "Tournament Name"
            : tripType === "Training"
            ? "Training Location (City)"
            : "Event Name";

        const contextPlaceholder =
          tripType === "Tournament"
            ? "e.g., 2025 Australian Open"
            : tripType === "Training"
            ? "e.g., Barcelona"
            : "e.g., Sponsor shoot â€“ Nike";

        function handleFilesChange(e) {
          const files = Array.from(e.target.files || []);
          setReceiptFiles(files);
        }

        async function handleSubmit(e) {
          e.preventDefault();
          const num = Number(amount);
          if (isNaN(num) || num <= 0) {
            alert("Please enter a positive amount");
            return;
          }

          const exp = {
            date,
            trip: trip.trim(),
            tripType,
            region: tripType === "Tournament" ? region : "",
            category,
            amount: num,
            currency: normCurrency || "USD",
            payer,
            notes: notes.trim(),
            manualRate: manualRate ? Number(manualRate) : null,
          };

          await onAdd(exp, receiptFiles);

          // keep context, reset amount/notes/files
          setAmount("");
          setNotes("");
          setReceiptFiles([]);
        }

        return (
          <form
            onSubmit={handleSubmit}
            className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 grid grid-cols-1 md:grid-cols-2 gap-4"
          >
            <h2 className="md:col-span-2 text-lg font-semibold text-slate-800">
              Add Expense
            </h2>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Date
              </label>
              <input
                type="date"
                value={date}
                onChange={(e) => setDate(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                required
              />
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Type
              </label>
              <select
                value={tripType}
                onChange={(e) => setTripType(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {CONTEXT_TYPES.map((t) => (
                  <option key={t} value={t}>
                    {t}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                {contextLabel}
              </label>
              <input
                type="text"
                placeholder={contextPlaceholder}
                value={trip}
                onChange={(e) => setTrip(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              />
            </div>

            {tripType === "Tournament" && (
              <div>
                <label className="block text-xs font-medium text-slate-700 mb-1">
                  Region (for comparisons)
                </label>
                <select
                  value={region}
                  onChange={(e) => setRegion(e.target.value)}
                  className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                >
                  <option value="">Select region</option>
                  {REGION_OPTIONS.map((r) => (
                    <option key={r} value={r}>
                      {r}
                    </option>
                  ))}
                </select>
              </div>
            )}

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Category
              </label>
              <select
                value={category}
                onChange={(e) => setCategory(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {CATEGORIES.map((c) => (
                  <option key={c} value={c}>
                    {c}
                  </option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Amount
              </label>
              <input
                type="number"
                step="0.01"
                min="0"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                placeholder="e.g., 120.50"
              />
            </div>

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Currency (USD, EUR, GBP, JPY, AUD, CAD, etc.)
              </label>
              <input
                type="text"
                value={currency}
                onChange={(e) => setCurrency(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm uppercase focus:outline-none focus:ring-2 focus:ring-slate-500"
                placeholder="USD"
              />
              {!knownFX && normCurrency && (
                <p className="mt-1 text-[11px] text-amber-700">
                  This currency is not auto-supported. Please enter a manual FX
                  rate to USD below.
                </p>
              )}
            </div>

            {!autoFX && normCurrency && normCurrency !== "USD" && (
              <div>
                <label className="block text-xs font-medium text-slate-700 mb-1">
                  Manual FX rate to USD
                </label>
                <div className="flex items-center gap-1 text-xs">
                  <span>1&nbsp;{normCurrency} =</span>
                  <input
                    type="number"
                    step="0.0001"
                    min="0"
                    value={manualRate}
                    onChange={(e) => setManualRate(e.target.value)}
                    className="w-24 rounded-xl border border-slate-300 px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-slate-500"
                    placeholder="e.g. 1.25"
                  />
                  <span>USD</span>
                </div>
                <p className="mt-1 text-[10px] text-slate-500">
                  Example: if 1 {normCurrency} = 1.25 USD, enter{" "}
                  <span className="font-semibold">1.25</span>.
                </p>
              </div>
            )}

            <div>
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Paid By
              </label>
              <select
                value={payer}
                onChange={(e) => setPayer(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
              >
                {PAYERS.map((p) => (
                  <option key={p} value={p}>
                    {p}
                  </option>
                ))}
              </select>
            </div>

            <div className="md:col-span-2">
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Notes
              </label>
              <textarea
                rows={2}
                value={notes}
                onChange={(e) => setNotes(e.target.value)}
                className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                placeholder="Optional details (e.g., coach name, sessions, etc.)"
              />
            </div>

            <div className="md:col-span-2">
              <label className="block text-xs font-medium text-slate-700 mb-1">
                Receipts (JPG/PNG/PDF)
              </label>
              <input
                type="file"
                multiple
                accept="image/*,application/pdf"
                onChange={handleFilesChange}
                className="block w-full text-xs text-slate-700"
              />
              <p className="mt-1 text-[10px] text-slate-500">
                Files are uploaded to Supabase Storage (bucket:{" "}
                <code>receipts</code>) and linked to this expense.
              </p>
            </div>

            <div className="md:col-span-2 flex justify-end">
              <button
                type="submit"
                disabled={saving}
                className={
                  "px-4 py-2 rounded-xl text-sm font-semibold transition " +
                  (saving
                    ? "bg-slate-400 text-white cursor-not-allowed"
                    : "bg-slate-900 text-white hover:bg-slate-800")
                }
              >
                {saving ? "Saving..." : "Save Expense"}
              </button>
            </div>
          </form>
        );
      }

      // ----- Filters Panel -----
      function FiltersPanel({ allExpenses, filters, onChange }) {
        const tripOptions = useMemo(() => {
          const s = new Set();
          allExpenses.forEach((e) => {
            if (e.trip) s.add(e.trip);
          });
          return Array.from(s).sort();
        }, [allExpenses]);

        const categoryOptions = useMemo(() => {
          const s = new Set();
          allExpenses.forEach((e) => {
            if (e.category) s.add(e.category);
          });
          return Array.from(s).sort();
        }, [allExpenses]);

        function handleChange(key, value) {
          onChange({ ...filters, [key]: value });
        }

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6">
            <h2 className="text-lg font-semibold text-slate-800 mb-3">
              Filters
            </h2>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
              <div>
                <label className="block text-xs font-medium text-slate-700 mb-1">
                  From
                </label>
                <input
                  type="date"
                  value={filters.from}
                  onChange={(e) => handleChange("from", e.target.value)}
                  className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                  placeholder="mm/dd/yyyy"
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-slate-700 mb-1">
                  To
                </label>
                <input
                  type="date"
                  value={filters.to}
                  onChange={(e) => handleChange("to", e.target.value)}
                  className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                  placeholder="mm/dd/yyyy"
                />
              </div>
              <div>
                <label className="block text-xs font-medium text-slate-700 mb-1">
                  Tournament / Location / Event
                </label>
                <select
                  value={filters.trip}
                  onChange={(e) => handleChange("trip", e.target.value)}
                  className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                >
                  <option value="All">All</option>
                  {tripOptions.map((t) => (
                    <option key={t} value={t}>
                      {t}
                    </option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-xs font-medium text-slate-700 mb-1">
                  Category
                </label>
                <select
                  value={filters.category}
                  onChange={(e) => handleChange("category", e.target.value)}
                  className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
                >
                  <option value="All">All</option>
                  {categoryOptions.map((c) => (
                    <option key={c} value={c}>
                      {c}
                    </option>
                  ))}
                </select>
              </div>
            </div>
          </div>
        );
      }

      // ----- Summary -----
      function Summary({ expenses }) {
        if (expenses.length === 0) return null;

        const totalUSD = expenses.reduce(
          (acc, e) => acc + (e.amount_usd || 0),
          0
        );

        const byCurrency = expenses.reduce((acc, e) => {
          const code = normalizeCurrency(e.currency);
          if (!code) return acc;
          if (!acc[code]) acc[code] = 0;
          acc[code] += Number(e.amount || 0);
          return acc;
        }, {});

        const byCategoryUSD = expenses.reduce((acc, e) => {
          if (!e.amount_usd) return acc;
          if (!acc[e.category]) acc[e.category] = 0;
          acc[e.category] += Number(e.amount_usd);
          return acc;
        }, {});
        const catEntries = Object.entries(byCategoryUSD).sort(
          (a, b) => b[1] - a[1]
        );

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <h2 className="text-lg font-semibold text-slate-800 mb-1">
                Total (USD)
              </h2>
              <p className="text-3xl font-bold text-slate-900">
                {totalUSD.toFixed(2)}{" "}
                <span className="text-base font-medium text-slate-500">
                  USD
                </span>
              </p>
              <p className="mt-1 text-xs text-slate-500">
                {expenses.length} expense
                {expenses.length !== 1 ? "s" : ""} (only those with FX are in
                USD total)
              </p>
            </div>
            <div>
              <h3 className="text-sm font-semibold text-slate-700 mb-2">
                By Category (USD)
              </h3>
              <div className="space-y-1 text-xs">
                {catEntries.map(([cat, val]) => (
                  <div
                    key={cat}
                    className="flex justify-between bg-slate-50 rounded-xl px-3 py-1"
                  >
                    <span>{cat}</span>
                    <span className="font-semibold">
                      {val.toFixed(2)} USD
                    </span>
                  </div>
                ))}
                {catEntries.length === 0 && (
                  <div className="text-slate-500">
                    No expenses with USD conversion yet.
                  </div>
                )}
              </div>
            </div>
            <div>
              <h3 className="text-sm font-semibold text-slate-700 mb-2">
                Native Currencies
              </h3>
              <div className="space-y-1 text-xs">
                {Object.entries(byCurrency).map(([code, val]) => (
                  <div
                    key={code}
                    className="flex justify-between bg-slate-50 rounded-xl px-3 py-1"
                  >
                    <span>{code}</span>
                    <span className="font-semibold">
                      {val.toFixed(2)} {code}
                    </span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      }

      // ----- Tournament Dashboard -----
      function TournamentDashboard({ expenses }) {
        const tournaments = useMemo(
          () => expenses.filter((e) => e.trip_type === "Tournament"),
          [expenses]
        );
        if (tournaments.length === 0) return null;

        const byTournament = {};
        tournaments.forEach((e) => {
          const key = e.trip || "Unspecified Tournament";
          if (!byTournament[key]) byTournament[key] = [];
          byTournament[key].push(e);
        });
        const tKeys = Object.keys(byTournament).sort();

        const byRegion = {};
        tKeys.forEach((tKey) => {
          const list = byTournament[tKey];
          const region = list[0].region || "Unspecified";
          const totalUSD = list.reduce(
            (acc, e) => acc + (e.amount_usd || 0),
            0
          );
          if (!byRegion[region]) byRegion[region] = { totalUSD: 0, count: 0 };
          byRegion[region].totalUSD += totalUSD;
          byRegion[region].count += 1;
        });
        const regionRows = Object.entries(byRegion)
          .map(([region, v]) => ({
            region,
            totalUSD: v.totalUSD,
            tournaments: v.count,
            avgUSD: v.count ? v.totalUSD / v.count : 0,
          }))
          .sort((a, b) => b.totalUSD - a.totalUSD);

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6">
            <h2 className="text-lg font-semibold text-slate-800 mb-2">
              Tournament Mode â€“ Cost per Event & Region
            </h2>
            <p className="text-xs text-slate-500 mb-3">
              Uses <strong>amount_usd</strong>. If FX could not be fetched and
              no manual rate was given, some entries wonâ€™t appear in USD totals.
            </p>

            <div className="mb-4">
              <h3 className="text-sm font-semibold text-slate-700 mb-2">
                Region Comparison (USD)
              </h3>
              <div className="overflow-x-auto">
                <table className="min-w-full text-[11px]">
                  <thead>
                    <tr className="border-b border-slate-200 text-left uppercase text-[10px] text-slate-500">
                      <th className="py-1 pr-3">Region</th>
                      <th className="py-1 pr-3 text-right">Total USD</th>
                      <th className="py-1 pr-3 text-right">Tournaments</th>
                      <th className="py-1 pr-3 text-right">
                        Avg / Tournament
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {regionRows.map((r) => (
                      <tr key={r.region} className="border-b border-slate-100">
                        <td className="py-1 pr-3 whitespace-nowrap">
                          {r.region}
                        </td>
                        <td className="py-1 pr-3 text-right">
                          {r.totalUSD.toFixed(2)}
                        </td>
                        <td className="py-1 pr-3 text-right">
                          {r.tournaments}
                        </td>
                        <td className="py-1 pr-3 text-right">
                          {r.avgUSD.toFixed(2)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
              {tKeys.map((tKey) => {
                const list = byTournament[tKey];
                const region = list[0].region || "Unspecified";
                const totalUSD = list.reduce(
                  (acc, e) => acc + (e.amount_usd || 0),
                  0
                );
                const byCategory = list.reduce((acc, e) => {
                  if (!e.amount_usd) return acc;
                  if (!acc[e.category]) acc[e.category] = 0;
                  acc[e.category] += e.amount_usd;
                  return acc;
                }, {});
                const catEntries = Object.entries(byCategory).sort(
                  (a, b) => b[1] - a[1]
                );
                const maxVal =
                  catEntries.length > 0
                    ? Math.max(...catEntries.map(([, v]) => v))
                    : 0;

                const receiptCount = list.reduce(
                  (acc, e) => acc + (e.receipts ? e.receipts.length : 0),
                  0
                );

                return (
                  <div
                    key={tKey}
                    className="border border-slate-200 rounded-xl p-3"
                  >
                    <div className="flex items-center justify-between mb-2">
                      <div>
                        <div className="font-semibold text-slate-800">
                          {tKey}
                        </div>
                        <div className="text-[11px] text-slate-500">
                          Region: {region} Â· {list.length} expenses Â· Receipts:{" "}
                          {receiptCount}
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="text-[11px] text-slate-500">
                          Total USD
                        </div>
                        <div className="font-bold text-slate-900">
                          {totalUSD.toFixed(2)}
                        </div>
                      </div>
                    </div>
                    {catEntries.length === 0 ? (
                      <div className="text-[11px] text-slate-500">
                        No USD-converted entries for this tournament yet.
                      </div>
                    ) : (
                      <div className="space-y-1">
                        {catEntries.map(([cat, val]) => {
                          const pct = maxVal ? (val / maxVal) * 100 : 0;
                          return (
                            <div key={cat}>
                              <div className="flex justify-between mb-0.5">
                                <span>{cat}</span>
                                <span>{val.toFixed(2)} USD</span>
                              </div>
                              <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                                <div
                                  className="h-2 bg-slate-500 rounded-full"
                                  style={{ width: `${pct}%` }}
                                ></div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>
        );
      }

      // ----- Export Panel (CSV + PDF) -----
      function ExportPanel({ expenses }) {
        if (!expenses.length) return null;

        function exportDetailed() {
          const rows = expenses.map((e) => ({
            Date: e.date,
            Type: e.trip_type || "",
            TournamentOrLocation: e.trip || "",
            Region: e.region || "",
            Category: e.category,
            Amount: e.amount,
            Currency: e.currency,
            FX_Rate_To_USD: e.fx_rate_to_usd || "",
            Amount_USD: e.amount_usd || "",
            Payer: e.payer || "",
            Notes: e.notes || "",
          }));
          const csv = buildCSV(rows);
          downloadFile("expenses_detailed.csv", csv, "text/csv;charset=utf-8;");
        }

        function exportByMonth() {
          const byMonth = {};
          expenses.forEach((e) => {
            const d = dayjs(e.date);
            const key = d.isValid() ? d.format("YYYY-MM") : "Unknown";
            if (!byMonth[key]) byMonth[key] = [];
            byMonth[key].push(e);
          });
          const rows = Object.entries(byMonth).map(([m, list]) => {
            const label =
              m === "Unknown"
                ? "Unknown"
                : dayjs(m + "-01").isValid()
                ? dayjs(m + "-01").format("MMMM YYYY")
                : m;
            const totalUSD = list.reduce(
              (acc, e) => acc + (e.amount_usd || 0),
              0
            );
            return {
              MonthKey: m,
              MonthLabel: label,
              Total_USD: totalUSD.toFixed(2),
              ExpenseCount: list.length,
            };
          });
          const csv = buildCSV(rows);
          downloadFile("expenses_by_month.csv", csv, "text/csv;charset=utf-8;");
        }

        function exportByTournament() {
          const tournaments = expenses.filter(
            (e) => e.trip_type === "Tournament"
          );
          const byTournament = {};
          tournaments.forEach((e) => {
            const key = e.trip || "Unspecified Tournament";
            if (!byTournament[key]) byTournament[key] = [];
            byTournament[key].push(e);
          });
          const rows = Object.entries(byTournament).map(([t, list]) => {
            const region = list[0].region || "";
            const totalUSD = list.reduce(
              (acc, e) => acc + (e.amount_usd || 0),
              0
            );
            return {
              Tournament: t,
              Region: region,
              Total_USD: totalUSD.toFixed(2),
              ExpenseCount: list.length,
            };
          });
          const csv = buildCSV(rows);
          downloadFile(
            "expenses_by_tournament.csv",
            csv,
            "text/csv;charset=utf-8;"
          );
        }

        function exportByPayer() {
          const byPayer = {};
          expenses.forEach((e) => {
            const key = e.payer || "Unspecified";
            if (!byPayer[key]) byPayer[key] = [];
            byPayer[key].push(e);
          });
          const rows = Object.entries(byPayer).map(([p, list]) => {
            const totalUSD = list.reduce(
              (acc, e) => acc + (e.amount_usd || 0),
              0
            );
            return {
              Payer_or_Coach: p,
              Total_USD: totalUSD.toFixed(2),
              ExpenseCount: list.length,
            };
          });
          const csv = buildCSV(rows);
          downloadFile(
            "expenses_by_payer.csv",
            csv,
            "text/csv;charset=utf-8;"
          );
        }

        function exportSummaryPDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          let y = 10;
          doc.setFontSize(14);
          doc.text("Athlete Expense Summary", 10, y);
          y += 6;

          doc.setFontSize(10);
          const totalUSD = expenses.reduce(
            (acc, e) => acc + (e.amount_usd || 0),
            0
          );
          doc.text(`Total USD (converted): ${totalUSD.toFixed(2)}`, 10, y);
          y += 5;
          doc.text(`Total entries: ${expenses.length}`, 10, y);
          y += 7;

          // By month
          doc.setFontSize(11);
          doc.text("By Month (USD)", 10, y);
          y += 5;
          doc.setFontSize(9);

          const byMonth = {};
          expenses.forEach((e) => {
            const d = dayjs(e.date);
            const key = d.isValid() ? d.format("YYYY-MM") : "Unknown";
            if (!byMonth[key]) byMonth[key] = [];
            byMonth[key].push(e);
          });

          for (const [m, list] of Object.entries(byMonth)) {
            const label =
              m === "Unknown"
                ? "Unknown"
                : dayjs(m + "-01").isValid()
                ? dayjs(m + "-01").format("MMMM YYYY")
                : m;
            const sum = list.reduce(
              (acc, e) => acc + (e.amount_usd || 0),
              0
            );
            const line = `${label}: ${sum.toFixed(2)} USD (${list.length} entries)`;
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
            doc.text(line, 12, y);
            y += 4;
          }

          y += 5;
          doc.setFontSize(11);
          if (y > 280) {
            doc.addPage();
            y = 10;
          }
          doc.text("By Tournament (USD)", 10, y);
          y += 5;
          doc.setFontSize(9);

          const tournaments = expenses.filter(
            (e) => e.trip_type === "Tournament"
          );
          const byTournament = {};
          tournaments.forEach((e) => {
            const key = e.trip || "Unspecified Tournament";
            if (!byTournament[key]) byTournament[key] = [];
            byTournament[key].push(e);
          });

          for (const [t, list] of Object.entries(byTournament)) {
            const region = list[0].region || "Unspecified";
            const sum = list.reduce(
              (acc, e) => acc + (e.amount_usd || 0),
              0
            );
            const line = `${t} (${region}): ${sum.toFixed(2)} USD (${list.length} entries)`;
            if (y > 280) {
              doc.addPage();
              y = 10;
            }
            doc.text(line, 12, y);
            y += 4;
          }

          doc.save("expense_summary.pdf");
        }

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6">
            <h2 className="text-lg font-semibold text-slate-800 mb-2">
              Export
            </h2>
            <p className="text-[11px] text-slate-500 mb-3">
              CSV opens in Excel / Numbers. Exports use the{" "}
              <strong>currently filtered</strong> expenses.
            </p>
            <div className="flex flex-wrap gap-2 text-xs">
              <button
                onClick={exportDetailed}
                className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              >
                Detailed CSV
              </button>
              <button
                onClick={exportByMonth}
                className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              >
                CSV â€“ by Month
              </button>
              <button
                onClick={exportByTournament}
                className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              >
                CSV â€“ by Tournament
              </button>
              <button
                onClick={exportByPayer}
                className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              >
                CSV â€“ by Payer / Coach
              </button>
              <button
                onClick={exportSummaryPDF}
                className="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              >
                PDF summary (for accountant / sponsor)
              </button>
            </div>
          </div>
        );
      }

      // ----- Backup & Restore Panel -----
      function BackupRestorePanel({ allExpenses, userId, onImported }) {
        const [exporting, setExporting] = useState(false);
        const [importing, setImporting] = useState(false);

        async function handleExportBackup() {
          if (!allExpenses.length) {
            alert("No expenses to back up.");
            return;
          }
          const JSZip = window.JSZip;
          if (!JSZip) {
            alert("JSZip not loaded");
            return;
          }
          try {
            setExporting(true);
            const zip = new JSZip();
            // Main data file
            zip.file(
              "expenses.json",
              JSON.stringify(allExpenses, null, 2),
              { binary: false }
            );

            // Optional: include copies of receipts for offline archive
            const receiptsFolder = zip.folder("receipts");
            const tasks = [];
            allExpenses.forEach((e, ei) => {
              if (!e.receipts || !e.receipts.length) return;
              e.receipts.forEach((r, ri) => {
                if (!r.url) return;
                const safeName =
                  (r.name || "receipt") + "_" + ei + "_" + ri;
                const filename = safeName.replace(/[^a-zA-Z0-9._-]/g, "_");
                tasks.push(
                  fetch(r.url)
                    .then((res) => res.arrayBuffer())
                    .then((buf) => {
                      receiptsFolder.file(filename, buf);
                    })
                    .catch(() => {
                      // ignore failing individual files
                    })
                );
              });
            });

            await Promise.all(tasks);

            const blob = await zip.generateAsync({ type: "blob" });
            downloadFile(
              "athlete_expenses_backup.zip",
              blob,
              "application/zip"
            );
          } finally {
            setExporting(false);
          }
        }

        async function handleImportBackup(event) {
          const file = event.target.files[0];
          if (!file) return;
          const JSZip = window.JSZip;
          setImporting(true);
          try {
            let expensesData = null;

            if (file.name.toLowerCase().endsWith(".json")) {
              const text = await file.text();
              expensesData = JSON.parse(text);
            } else if (file.name.toLowerCase().endsWith(".zip")) {
              if (!JSZip) {
                alert("JSZip not loaded");
                return;
              }
              const buf = await file.arrayBuffer();
              const zip = await JSZip.loadAsync(buf);
              const jsonFile = zip.file("expenses.json");
              if (!jsonFile) {
                alert("Backup ZIP does not contain expenses.json.");
                return;
              }
              const text = await jsonFile.async("string");
              expensesData = JSON.parse(text);
            } else {
              alert("Unsupported backup file type. Use .json or .zip.");
              return;
            }

            if (!Array.isArray(expensesData)) {
              alert("Invalid backup format (expected an array).");
              return;
            }

            // Insert for current user
            const rowsToInsert = expensesData.map((e) => {
              const {
                id,
                user_id,
                created_at,
                updated_at,
                inserted_at,
                ...rest
              } = e;
              return {
                ...rest,
                user_id: userId,
              };
            });

            // To stay under row limits we can insert in small batches
            const chunkSize = 100;
            for (let i = 0; i < rowsToInsert.length; i += chunkSize) {
              const chunk = rowsToInsert.slice(i, i + chunkSize);
              const { error } = await supabaseClient
                .from("expenses")
                .insert(chunk);
              if (error) {
                console.error(error);
                alert("Error importing some entries: " + error.message);
                break;
              }
            }

            await onImported();
            alert("Backup imported successfully.");
          } catch (err) {
            console.error(err);
            alert("Error importing backup: " + err.message);
          } finally {
            setImporting(false);
            // Reset file input so same file can be chosen again if needed
            event.target.value = "";
          }
        }

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6">
            <h2 className="text-lg font-semibold text-slate-800 mb-2">
              Backup &amp; Restore
            </h2>
            <p className="text-[11px] text-slate-500 mb-3">
              Export a full backup (including receipts &amp; FX info) as a
              <strong> JSON+ZIP</strong> file. You can import it on another
              computer or after reinstalling your browser. Receipts are kept in
              Supabase, and copies are included in the ZIP for archive.
            </p>
            <div className="flex flex-wrap gap-3 text-xs items-center">
              <button
                onClick={handleExportBackup}
                disabled={exporting}
                className={
                  "px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 " +
                  (exporting ? "opacity-60 cursor-wait" : "")
                }
              >
                {exporting ? "Exporting..." : "Export Backup (.zip)"}
              </button>
              <label className="inline-flex items-center px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50 cursor-pointer">
                <span>
                  {importing ? "Importing..." : "Import Backup (.json/.zip)"}
                </span>
                <input
                  type="file"
                  accept=".json,.zip"
                  className="hidden"
                  onChange={handleImportBackup}
                  disabled={importing}
                />
              </label>
            </div>
          </div>
        );
      }

      // ----- Expense Table -----
      function ExpenseTable({ expenses, onDelete }) {
        if (!expenses.length) {
          return (
            <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-10 text-sm text-slate-500">
              No expenses recorded yet.
            </div>
          );
        }

        return (
          <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-10">
            <h2 className="text-lg font-semibold text-slate-800 mb-3">
              Expenses
            </h2>
            <div className="overflow-x-auto text-xs">
              <table className="min-w-full">
                <thead>
                  <tr className="border-b border-slate-200 text-left uppercase text-[10px] text-slate-500">
                    <th className="py-2 pr-3">Date</th>
                    <th className="py-2 pr-3">Type</th>
                    <th className="py-2 pr-3">
                      Tournament / Location / Event
                    </th>
                    <th className="py-2 pr-3">Region</th>
                    <th className="py-2 pr-3">Category</th>
                    <th className="py-2 pr-3 text-right">Amount</th>
                    <th className="py-2 pr-3">Currency</th>
                    <th className="py-2 pr-3 text-right">USD</th>
                    <th className="py-2 pr-3">Payer</th>
                    <th className="py-2 pr-3">Receipts</th>
                    <th className="py-2 pr-3">Notes</th>
                    <th className="py-2 pr-3"></th>
                  </tr>
                </thead>
                <tbody>
                  {expenses.map((e) => (
                    <tr
                      key={e.id}
                      className="border-b border-slate-100 hover:bg-slate-50"
                    >
                      <td className="py-2 pr-3 whitespace-nowrap">
                        {e.date}
                      </td>
                      <td className="py-2 pr-3 whitespace-nowrap">
                        {e.trip_type || "-"}
                      </td>
                      <td className="py-2 pr-3 whitespace-nowrap">
                        {e.trip || "-"}
                      </td>
                      <td className="py-2 pr-3 whitespace-nowrap">
                        {e.region || "-"}
                      </td>
                      <td className="py-2 pr-3 whitespace-nowrap">
                        {e.category}
                      </td>
                      <td className="py-2 pr-3 text-right whitespace-nowrap">
                        {Number(e.amount || 0).toFixed(2)}
                      </td>
                      <td className="py-2 pr-3 whitespace-nowrap">
                        {normalizeCurrency(e.currency)}
                      </td>
                      <td className="py-2 pr-3 text-right whitespace-nowrap">
                        {e.amount_usd != null ? e.amount_usd.toFixed(2) : "-"}
                      </td>
                      <td className="py-2 pr-3 whitespace-nowrap">
                        {e.payer || "-"}
                      </td>
                      <td className="py-2 pr-3 whitespace-nowrap">
                        {e.receipts && e.receipts.length ? (
                          <div className="flex items-center gap-1">
                            {e.receipts.slice(0, 3).map((r) =>
                              r.type && r.type.startsWith("image/") ? (
                                <a
                                  key={r.path}
                                  href={r.url}
                                  target="_blank"
                                  rel="noreferrer"
                                >
                                  <img
                                    src={r.url}
                                    alt={r.name}
                                    title={r.name}
                                    className="w-7 h-7 rounded object-cover border border-slate-200"
                                  />
                                </a>
                              ) : (
                                <a
                                  key={r.path}
                                  href={r.url}
                                  target="_blank"
                                  rel="noreferrer"
                                  className="px-1.5 py-0.5 rounded border border-slate-300 text-[10px] text-slate-700"
                                >
                                  PDF
                                </a>
                              )
                            )}
                            {e.receipts.length > 3 && (
                              <span className="text-[10px] text-slate-500">
                                +{e.receipts.length - 3}
                              </span>
                            )}
                          </div>
                        ) : (
                          <span className="text-[10px] text-slate-400">
                            None
                          </span>
                        )}
                      </td>
                      <td className="py-2 pr-3 max-w-xs">
                        <span className="line-clamp-2">{e.notes}</span>
                      </td>
                      <td className="py-2 pr-3 text-right">
                        <button
                          onClick={() => {
                            if (
                              window.confirm(
                                "Delete this expense? This cannot be undone."
                              )
                            ) {
                              onDelete(e.id);
                            }
                          }}
                          className="text-[11px] text-red-600 hover:text-red-700"
                        >
                          Delete
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        );
      }

// ----- Feedback Section (Web3Forms) -----
function FeedbackSection({ userEmail }) {
  const [message, setMessage] = React.useState("");
  const [contact, setContact] = React.useState("");
  const [status, setStatus] = React.useState("idle"); // idle | sending | success | error

  async function handleSubmit(e) {
    e.preventDefault();
    if (!message.trim()) {
      alert("Please type some feedback first.");
      return;
    }

    setStatus("sending");

    try {
      const formData = {
        access_key: "76ce33fe-3e89-464e-97c6-7dc404dc67d2", // ðŸ‘ˆ replace this
        subject: "Xpenseez / bacKHand tennis Feedback",
        message,
        contact,
        app_user_email: userEmail || "",
        from_page: window.location.href,
      };

      const res = await fetch("https://api.web3forms.com/submit", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify(formData),
      });

      if (res.ok) {
        setStatus("success");
        setMessage("");
        setContact("");
      } else {
        console.error("Web3Forms error:", res.status);
        setStatus("error");
      }
    } catch (err) {
      console.error("Feedback submit error:", err);
      setStatus("error");
    }
  }

  return (
    <div 
id="feedback-section"
className="bg-white rounded-2xl shadow p-4 md:p-6 mb-10">
      <h2 className="text-lg font-semibold text-slate-800 mb-1">
        Feedback
      </h2>
      <p className="text-xs text-slate-500 mb-3">
        Tell us what youâ€™d like improved in Athlete Expenses / bacKHand
        Tennis. This goes directly to the developer.
      </p>

      <form onSubmit={handleSubmit} className="space-y-3 text-sm">
        <div>
          <label className="block text-xs font-medium text-slate-700 mb-1">
            Your feedback
          </label>
          <textarea
            rows={3}
            value={message}
            onChange={(e) => setMessage(e.target.value)}
            className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
            placeholder="What's working well? What's confusing or missing?"
          />
        </div>

        <div>
          <label className="block text-xs font-medium text-slate-700 mb-1">
            Contact (optional)
          </label>
          <input
            type="text"
            value={contact}
            onChange={(e) => setContact(e.target.value)}
            className="w-full rounded-xl border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-slate-500"
            placeholder="Email, WhatsApp, or leave blank"
          />
        </div>

        <div className="flex items-center justify-between gap-3">
          <button
            type="submit"
            disabled={status === "sending"}
            className={
              "px-4 py-2 rounded-xl text-xs font-semibold " +
              (status === "sending"
                ? "bg-slate-400 text-white cursor-not-allowed"
                : "bg-slate-900 text-white hover:bg-slate-800")
            }
          >
            {status === "sending" ? "Sending..." : "Send feedback"}
          </button>

          {status === "success" && (
            <span className="text-[11px] text-emerald-600">
              Thanks! Feedback sent.
            </span>
          )}
          {status === "error" && (
            <span className="text-[11px] text-red-600">
              Something went wrong. Try again later.
            </span>
          )}
        </div>
      </form>
    </div>
  );
}


      // ----- App -----
      function App({ session }) {
        const [expenses, setExpenses] = useState([]);
        const [loading, setLoading] = useState(true);
        const [saving, setSaving] = useState(false);
	const [plan, setPlan] = useState("free"); // ðŸ‘ˆ add this if not already there

        const [filters, setFilters] = useState({
          from: "",
          to: "",
          trip: "All",
          category: "All",
        });

        async function loadExpenses() {
          setLoading(true);
          const { data, error } = await supabaseClient
            .from("expenses")
            .select("*")
            .eq("user_id", session.user.id)
            .order("date", { ascending: true });
          if (error) {
            console.error(error);
            alert("Error loading expenses: " + error.message);
            setExpenses([]);
          } else {
            setExpenses(data || []);
          }
          setLoading(false);
        }

        useEffect(() => {
          loadExpenses();
        }, [session.user.id]);


  // ---- Storage usage + plan info ----
  const usedBytes = useMemo(
    () => calcUsedStorageBytes(expenses),
    [expenses]
  );
  const currentPlan = plan || "free";
  const limitBytes = getStorageLimitBytes(currentPlan);
  const usedMB = usedBytes / (1024 * 1024);
  const limitMB = limitBytes / (1024 * 1024);
  const usedPct =
    limitBytes > 0 ? Math.min(100, (usedBytes / limitBytes) * 100) : 0;

  function handleUpgradeClick() {
    if (currentPlan === "pro") {
      alert("You are already on the Pro plan.");
      return;
    }
    alert(
      "Upgrade to Pro coming soon.\n\nFor now, contact us to increase your storage limit."
    );
  }


        const filteredExpenses = useMemo(() => {
          return expenses.filter((e) => {
            if (filters.from && e.date < filters.from) return false;
            if (filters.to && e.date > filters.to) return false;
            if (filters.trip !== "All" && (e.trip || "") !== filters.trip)
              return false;
            if (
              filters.category !== "All" &&
              (e.category || "") !== filters.category
            )
              return false;
            return true;
          });
        }, [expenses, filters]);

        async function computeFx(exp) {
          const code = normalizeCurrency(exp.currency);
          const amount = Number(exp.amount || 0);
          if (!amount) return { fxRate: null, amountUsd: null };

          // USD: trivial
          if (code === "USD") {
            return { fxRate: 1, amountUsd: amount };
          }

          // Unsupported, manual required
          if (!ALL_FX_KNOWN.includes(code)) {
            if (!exp.manualRate || exp.manualRate <= 0) {
              throw new Error(
                `Currency ${code} is not supported automatically. Please enter a manual FX rate.`
              );
            }
            return {
              fxRate: exp.manualRate,
              amountUsd: amount * exp.manualRate,
            };
          }

          // Supported automatic (EUR/GBP/JPY/AUD/CAD)
          const dateStr = dayjs(exp.date).isValid()
            ? dayjs(exp.date).format("YYYY-MM-DD")
            : null;

          try {
            const url = dateStr
              ? `https://api.frankfurter.app/${dateStr}?from=${code}&to=USD`
              : `https://api.frankfurter.app/latest?from=${code}&to=USD`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("FX API error");
            const data = await res.json();
            const rate = data?.rates?.USD;
            if (!rate) throw new Error("Rate missing");
            return { fxRate: rate, amountUsd: amount * rate };
          } catch (err) {
            console.warn("FX fetch failed, trying manual", err);
            if (exp.manualRate && exp.manualRate > 0) {
              return {
                fxRate: exp.manualRate,
                amountUsd: amount * exp.manualRate,
              };
            }
            // Save without USD, but warn
            alert(
              `Could not fetch FX for ${code}. Saving without USD conversion. You can edit later or add manual rate.`
            );
            return { fxRate: null, amountUsd: null };
          }
        }

        async function handleAdd(exp, files) {
          
          // ðŸ‘‡ 1) DETERMINE USER PLAN
  // For now, hardcode. Later we read from Supabase "profiles" table.
  const plan = "free";  // change when implementing paid tiers

  // ðŸ‘‡ 2) CHECK STORAGE LIMIT BEFORE UPLOADING
  const limitBytes = getStorageLimitBytes(plan);
  const existingBytes = calcUsedStorageBytes(expenses);
  const newBytes = (files || []).reduce((sum, f) => sum + (f.size || 0), 0);

  if (existingBytes + newBytes > limitBytes) {
    const limitMB = (limitBytes / (1024 * 1024)).toFixed(0);
    alert(
      `You are over your ${plan.toUpperCase()} plan limit of ${limitMB} MB. ` +
      `Delete receipts or upgrade your plan to continue.`
    );
    return; // ðŸš« STOP â€” do not upload or insert row
  }
          setSaving(true);
          try {
            const { fxRate, amountUsd } = await computeFx(exp);

            const regionVal =
              exp.tripType === "Tournament" && exp.region
                ? exp.region
                : null;

            // Insert expense without receipts first
            const { data: inserted, error } = await supabaseClient
              .from("expenses")
              .insert({
                user_id: session.user.id,
                date: exp.date,
                trip: exp.trip,
                trip_type: exp.tripType,
                region: regionVal,
                category: exp.category,
                amount: exp.amount,
                currency: normalizeCurrency(exp.currency),
                fx_rate_to_usd: fxRate,
                amount_usd: amountUsd,
                payer: exp.payer,
                notes: exp.notes,
                receipts: [],
              })
              .select()
              .single();

            if (error) {
              console.error(error);
              alert("Error saving expense: " + error.message);
              return;
            }

            let finalExpense = inserted;

            // Upload receipts to Supabase Storage
            if (files && files.length > 0) {
              const receiptMeta = [];
              for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, "_");
                const path = `${session.user.id}/${inserted.id}/${Date.now()}_${i}_${safeName}`;

                const { error: uploadError } = await supabaseClient.storage
                  .from("receipts")
                  .upload(path, file);

                if (uploadError) {
                  console.error("Upload error", uploadError);
                  alert(
                    "Some receipts failed to upload. Expense saved without those files."
                  );
                  continue;
                }

                const { data: publicData } = supabaseClient.storage
                  .from("receipts")
                  .getPublicUrl(path);

                receiptMeta.push({
                  name: file.name,
                  type: file.type,
                  size_bytes: file.size,
                  url: publicData.publicUrl,
                  path,
                });
              }

              if (receiptMeta.length > 0) {
                const { data: updated, error: updateErr } =
                  await supabaseClient
                    .from("expenses")
                    .update({ receipts: receiptMeta })
                    .eq("id", inserted.id)
                    .eq("user_id", session.user.id)
                    .select()
                    .single();

                if (!updateErr && updated) {
                  finalExpense = updated;
                } else {
                  // fall back to local merge
                  finalExpense = { ...inserted, receipts: receiptMeta };
                }
              }
            }

            setExpenses((prev) =>
              [...prev, finalExpense].sort((a, b) =>
                String(a.date).localeCompare(String(b.date))
              )
            );
          } finally {
            setSaving(false);
          }
        }

        async function handleDelete(id) {
          const { error } = await supabaseClient
            .from("expenses")
            .delete()
            .eq("id", id)
            .eq("user_id", session.user.id);
          if (error) {
            console.error(error);
            alert("Error deleting expense: " + error.message);
            return;
          }
          setExpenses((prev) => prev.filter((e) => e.id !== id));
        }

        return (
          <main className="max-w-5xl mx-auto px-4 py-6 flex-1">
              <div className="mb-4 bg-white rounded-2xl shadow p-4 md:p-6">
    <div className="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
      {/* Left: overview text */}
      <div>
        <h2 className="text-lg font-semibold text-slate-800 mb-1">
          Overview
        </h2>
        <p className="text-sm text-slate-500 mb-2">
          Data is stored centrally in Supabase. Currency is stored in
          native form and, where possible, converted to USD using live FX
          (Frankfurter API) or your manual rates.
        </p>
        <p className="text-xs text-slate-600">
          Total entries:{" "}
          <span className="font-semibold">{expenses.length}</span>
        </p>
        <p className="mt-1 text-[11px] text-slate-500">
          Current plan:{" "}
          <span className="font-semibold uppercase">{currentPlan}</span>
        </p>
      </div>

      {/* Right: storage meter + upgrade button */}
      <div className="w-full md:w-64">
        <div className="flex items-center justify-between text-[11px] text-slate-500 mb-1">
          <span>Storage used</span>
          <span>
            {usedMB.toFixed(1)} MB / {limitMB.toFixed(0)} MB (
            {usedPct.toFixed(1)}%)
          </span>
        </div>
        <div className="h-2.5 w-full bg-slate-200 rounded-full overflow-hidden">
          <div
            className={
              "h-2.5 rounded-full transition-all " +
              (usedPct > 90
                ? "bg-red-500"
                : usedPct > 70
                ? "bg-amber-500"
                : "bg-emerald-500")
            }
            style={{ width: `${usedPct}%` }}
          ></div>
        </div>

        {currentPlan === "free" && (
          <button
            type="button"
            onClick={handleUpgradeClick}
            className="mt-3 w-full inline-flex items-center justify-center px-3 py-2 rounded-xl bg-slate-900 text-white text-xs font-semibold hover:bg-slate-800"
          >
            Upgrade to Pro for more storage
          </button>
        )}

        {currentPlan === "pro" && (
          <p className="mt-3 text-[11px] text-emerald-600 font-medium text-right">
            Pro plan active â€“ expanded storage enabled.
          </p>
        )}
      </div>
    </div>
  </div>


            <ExpenseForm onAdd={handleAdd} saving={saving} />

            <FiltersPanel
              allExpenses={expenses}
              filters={filters}
              onChange={setFilters}
            />

            {loading ? (
              <div className="bg-white rounded-2xl shadow p-4 md:p-6 mb-6 text-sm text-slate-500">
                Loading expenses...
              </div>
            ) : (
              <>
                <Summary expenses={filteredExpenses} />
                <BackupRestorePanel
                  allExpenses={expenses}
                  userId={session.user.id}
                  onImported={loadExpenses}
                />
                <ExportPanel expenses={filteredExpenses} />
                <TournamentDashboard expenses={filteredExpenses} />


                <ExpenseTable
                  expenses={filteredExpenses}
                  onDelete={handleDelete}
                />
{/* ðŸ‘‡ New feedback card */}
        <FeedbackSection userEmail={session.user.email} />

              </>
            )}
          </main>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(
        <AuthGate>
          {(session) => <App session={session} />}
        </AuthGate>
      );
    </script>
  </body>
</html>
